// ==UserScript==
// @name            Following Overcharged
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Various improvements to the "follow" feature
// @grant           unsafeWindow
// @homepage        https://github.com/userscripters/following-overcharged#readme
// @match           https://stackoverflow.com/questions/*
// @match           https://stackoverflow.com/users/*
// @match           https://serverfault.com/questions/*
// @match           https://serverfault.com/users/*
// @match           https://superuser.com/questions/*
// @match           https://superuser.com/users/*
// @match           https://*.stackexchange.com/questions/*
// @match           https://*.stackexchange.com/users/*
// @match           https://askubuntu.com/questions/*
// @match           https://askubuntu.com/users/*
// @match           https://stackapps.com/questions/*
// @match           https://stackapps.com/users/*
// @match           https://mathoverflow.net/questions/*
// @match           https://mathoverflow.net/users/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/users/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/users/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/users/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/users/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.stackoverflow.com/users/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.serverfault.com/users/*
// @match           https://meta.superuser.com/questions/*
// @match           https://meta.superuser.com/users/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.askubuntu.com/users/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.mathoverflow.net/users/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.meta.stackoverflow.com/users/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/users/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/users/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.meta.stackoverflow.com/users/*
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/following-overcharged.git
// @supportURL      https://github.com/userscripters/following-overcharged/issues
// @version         1.8.2
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,s,i,l){return new(i=i||Promise)(function(o,t){function n(e){try{a(l.next(e))}catch(e){t(e)}}function r(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?o(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(n,r)}a((l=l.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,s,i,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(o){return function(e){var t=[o,e];if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,s&&(i=2&t[0]?s.return:t[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,t[1])).done)return i;switch(s=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,s=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(i=0<(i=l.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){l.label=t[1];break}if(6===t[0]&&l.label<i[1]){l.label=i[1],i=t;break}if(i&&l.label<i[2]){l.label=i[2],l.ops.push(t);break}i[2]&&l.ops.pop(),l.trys.pop();continue}t=r.call(n,l)}catch(e){t=[6,e],s=0}finally{a=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var o="function"==typeof Symbol&&e[Symbol.iterator];if(!o)return e;var n,r,a=o.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(n=a.next()).done;)s.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(o=a.return)&&o.call(a)}finally{if(r)throw r.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t,o){if(o||2===arguments.length)for(var n,r=0,a=t.length;r<a;r++)!n&&r in t||((n=n||Array.prototype.slice.call(t,0,r))[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,o=t&&e[t],n=0;if(o)return o.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&n>=e.length?void 0:e)&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},scriptName="following-overcharged",makeStacksButton=function(e,t,o){var n=(o=void 0===o?{}:o).classes,n=void 0===n?[]:n,r=o.title,a=o.danger,a=void 0!==a&&a,s=o.loading,s=void 0!==s&&s,i=o.muted,i=void 0!==i&&i,l=o.primary,l=void 0!==l&&l,o=o.type,o=void 0===o?"filled":o,c=document.createElement("button");return c.id=e,c.textContent=t,(e=c.classList).add.apply(e,__spreadArray(["s-btn","s-btn__".concat(o)],__read(n),!1)),c.setAttribute("role","button"),c.setAttribute("aria-label",r||t),a&&c.classList.add("s-btn__danger"),i&&c.classList.add("s-btn__muted"),l&&c.classList.add("s-btn__primary"),s&&c.classList.add("is-loading"),r&&(c.title=r),c},makeStacksIcon=function(e,t,o){var n=(o=void 0===o?{}:o).classes,n=void 0===n?[]:n,r=o.hidden,r=void 0!==r&&r,a=o.namespace,a=void 0===a?"http://www.w3.org/2000/svg":a,s=o.height,s=void 0===s?18:s,o=o.width,o=void 0===o?18:o,i=document.createElementNS(a,"svg"),l=((l=i.classList).add.apply(l,__spreadArray(["svg-icon",e],__read(n),!1)),i.setAttribute("width",o.toString()),i.setAttribute("height",s.toString()),i.setAttribute("viewBox","0 0 ".concat(o," ").concat(s)),i.setAttribute("aria-hidden","true"),r&&i.classList.add("d-none"),document.createElementNS(a,"path"));return l.setAttribute("d",t),i.append(l),i},makeDraggable=function(i){document.addEventListener("dragstart",function(e){var e=e.dataTransfer,t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});function t(e){var t,o,n,r,a=e.clientX,e=e.clientY,s=document.getElementById(i);s&&(l=l||a,c=c||e,t=(o=s.style).top,o=o.left,t||o||(t=(n=window.getComputedStyle(s)).top,o=n.left),[n=a-l,r=e-c].map(Math.abs).some(function(e){return 500<e})||((s=s.style).left="".concat(parseInt(o)+n,"px"),s.top="".concat(parseInt(t)+r,"px"),l=a,c=e))}var l=0,c=0,o=0,n=!1;document.addEventListener("dragstart",function(e){e.target===document.getElementById(i)&&(n=!0)}),document.addEventListener("dragend",function(e){e.target===document.getElementById(i)&&(n=!1,c=l=0)}),document.addEventListener("drag",function(e){if(!(3<=(o=e.clientX?0:o<3?o+1:3))&&n)return t(e)}),document.addEventListener("dragover",function(e){if(n&&e.preventDefault(),!(o<3)&&n)return t(e)})},makeStacksModal=function(e,t,o){var o=o.minWidth,n="modal-title",r=document.createElement("aside"),a=(r.classList.add("s-modal"),r.id=e,r.tabIndex=-1,r.setAttribute("role","dialog"),r.setAttribute("aria-labelledby",n),r.setAttribute("aria-describeddy","modal-description"),r.setAttribute("aria-hidden","true"),r.dataset),a=(a.sModalTarget="modal",a.controller="s-modal",document.createElement("div")),o=(a.classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(o)),a.setAttribute("role","document"),a.id="".concat(e,"-document"),a.draggable=!0,document.createElement("h1")),e=(o.classList.add("s-modal--header"),o.id=n,o.textContent=t,document.createElement("button")),n=(e.classList.add("s-modal--close","s-btn","s-btn__muted"),e.type="button",e.dataset.action="s-modal#hide",makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14}));return makeDraggable(a.id),e.append(n),a.append(o,e),r.append(a),[r,a]},observe=function(n,r,a){function e(e,t){var o=r.querySelectorAll(n);o.length&&a(__spreadArray([],__read(o),!1),t)}var t=new MutationObserver(e);return t.observe(r,{attributes:!0,childList:!0,subtree:!0}),e(0,t),t},delay=function(t){return void 0===t&&(t=100),new Promise(function(e){return setTimeout(e,t)})},normalizeDatasetPropName=function(e){return e.split("-").map(function(e,t){var e=__read(e),o=e[0],e=e.slice(1);return"".concat(t?o.toUpperCase():o.toLowerCase()).concat(e.join("").toLowerCase())}).join("")},followPost=function(n,r,a){return __awaiter(void 0,void 0,void 0,function(){var t,o;return __generator(this,function(e){switch(e.label){case 0:return t=new URL("".concat(location.origin,"/posts/").concat(r,"/vote/21")),(o=new URLSearchParams).set("fkey",n),[4,fetch(t.toString(),{body:o,credentials:"include",method:"POST",signal:a})];case 1:return[2,e.sent().ok]}})})},unfollowPost=function(n,r,a){return __awaiter(void 0,void 0,void 0,function(){var t,o;return __generator(this,function(e){switch(e.label){case 0:return(t=new URL("".concat(location.origin,"/posts/").concat(r,"/vote/21"))).searchParams.append("undo","true"),(o=new URLSearchParams).set("fkey",n),[4,fetch(t.toString(),{body:o,credentials:"include",method:"POST",signal:a})];case 1:return[2,e.sent().ok]}})})},followCount=0,isElementNode=function(e){return e.nodeType===Node.ELEMENT_NODE},matches=function(e,t){return e.matches(t)},waitForAdded=function(n,e){return void 0===e&&(e=document),new Promise(function(o){new MutationObserver(function(e,t){e=e.flatMap(function(e){return __spreadArray([],__read(e.addedNodes),!1)}).filter(isElementNode).flatMap(function(e){return matches(e,n)?e:__spreadArray([],__read(e.querySelectorAll(n)),!1)});e.length&&(t.disconnect(),o(e))}).observe(e,{attributes:!0,childList:!0,subtree:!0})})},registerFollowPostObserver=function(e){return observe(e,document,function(d,u){return __awaiter(void 0,void 0,void 0,function(){var t,o,n,r,a,s,i,l,c;return __generator(this,function(e){switch(e.label){case 0:if(100<followCount)return console.debug("[".concat(scriptName,"] attempted to follow >= 100 posts, disconnecting")),u.disconnect(),[2];t=normalizeDatasetPropName("".concat(scriptName,"-state")),o=StackExchange.options.user.fkey,e.label=1;case 1:e.trys.push([1,8,9,10]),n=__values(d),r=n.next(),e.label=2;case 2:return r.done?[3,7]:"follow"===(a=r.value).dataset[t]?[3,6]:(c=null==(c=null==(c=a.textContent)?void 0:c.toLowerCase())?void 0:c.trim())?+(s=a.id.replace("btnFollowPost-",""))?"follow"!==c?[3,4]:(followCount+=1,[4,followPost(o,s)]):(console.debug("[".concat(scriptName,"] failed to get postId from follow button")),[3,6]):(console.debug("[".concat(scriptName,"] empty follow button found")),[3,6]);case 3:e.sent(),a.dataset[t]=c,a.textContent="Following",e.label=4;case 4:return[4,delay(500)];case 5:e.sent(),e.label=6;case 6:return r=n.next(),[3,2];case 7:return[3,10];case 8:return s=e.sent(),i={error:s},[3,10];case 9:try{r&&!r.done&&(l=n.return)&&l.call(n)}finally{if(i)throw i.error}return[7];case 10:return[2]}})})})},registerEditObserver=function(e){var a=normalizeDatasetPropName("".concat(scriptName,"-edit-state"));return observe(e,document,function(e){var t,o;try{for(var n=__values(e),r=n.next();!r.done;r=n.next())!function(n){if("follow"===n.dataset[a])return;n.dataset[a]="follow",n.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){var t,o;return __generator(this,function(e){switch(e.label){case 0:return+(t=n.id.replace("submit-button-",""))?[4,followPost(StackExchange.options.user.fkey,t)]:(console.debug("[".concat(scriptName,"] invalid post id: ").concat(t)),[2]);case 1:return e.sent(),[4,waitForAdded("#btnFollowPost-".concat(t),document)];case 2:return o=__read.apply(void 0,[e.sent(),1]),(o=o[0])&&(o.textContent="Following"),[2]}})})})}(r.value)}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=n.return)&&o.call(n)}finally{if(t)throw t.error}}})},registerVoteObserver=function(e){var a=normalizeDatasetPropName("".concat(scriptName,"-dv-state"));return observe(e,document,function(e){var t,o;try{for(var n=__values(e),r=n.next();!r.done;r=n.next())!function(r){if("follow"===r.dataset[a])return;r.dataset[a]="follow",r.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){var t,o,n;return __generator(this,function(e){switch(e.label){case 0:return[4,delay(1e3)];case 1:return(e.sent(),"true"!==r.getAttribute("aria-pressed"))?[2]:(t=r.closest(".question, .answer"))?(n=t.dataset,o=n.answerid,n=n.questionid,(o=o||n)?[4,followPost(StackExchange.options.user.fkey,o)]:(console.debug("[".concat(scriptName,"] missing post id")),[2])):(console.debug("[".concat(scriptName,"] missing post container")),[2]);case 2:return e.sent(),(n=t.querySelector(".js-follow-post"))&&(n.textContent="Following"),[2]}})})})}(r.value)}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=n.return)&&o.call(n)}finally{if(t)throw t.error}}})},registerPopupObserver=function(e,s){var i=normalizeDatasetPropName("".concat(scriptName,"-vtc-state"));return observe(e,document,function(e){var t,o;try{for(var n=__values(e),r=n.next();!r.done;r=n.next()){var a=function(e){if("follow"===e.dataset[i])return"continue";e.dataset[i]="follow";var n=e.closest("#popup-".concat(s));if(!n)return console.debug("[".concat(scriptName,"] missing ").concat(s," popup dialog")),{value:void 0};e.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){var t,o;return __generator(this,function(e){switch(e.label){case 0:return[4,delay(1e3)];case 1:return(e.sent(),t=n.dataset.postid)?[4,followPost(StackExchange.options.user.fkey,t)]:(console.debug("[".concat(scriptName,"] missing post id")),[2]);case 2:return e.sent(),(o=document.getElementById("btnFollowPost-".concat(t)))&&(o.textContent="Following"),[2]}})})})}(r.value);if("object"==typeof a)return a.value}}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=n.return)&&o.call(n)}finally{if(t)throw t.error}}})},registerCommentObserver=function(e){var a=normalizeDatasetPropName("".concat(scriptName,"-comment-state"));return observe(e,document,function(e){var t,o;try{for(var n=__values(e),r=n.next();!r.done;r=n.next())!function(n){if("follow"===n.dataset[a])return;n.dataset[a]="follow",n.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){var t,o;return __generator(this,function(e){switch(e.label){case 0:return[4,delay(1e3)];case 1:return(e.sent(),o=n.closest("[id^='add-comment']"))?(t=o.id.replace("add-comment-",""),[4,followPost(StackExchange.options.user.fkey,t)]):(console.debug("[".concat(scriptName,"] missing comment form")),[2]);case 2:return e.sent(),(o=document.getElementById("btnFollowPost-".concat(t)))&&(o.textContent="Following"),[2]}})})})}(r.value)}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=n.return)&&o.call(n)}finally{if(t)throw t.error}}})},unfollowedPostIdsCache=new Set,unfollowPosts=function(p,w,v){return __awaiter(void 0,void 0,void 0,function(){var t,o,n,r,a,s,i,l,c,d,u,f;return __generator(this,function(e){switch(e.label){case 0:return(e.trys.push([0,13,,14]),o=StackExchange.options.user.userId)?(o=new URL("".concat(location.origin,"/users/").concat(o)),(t=o.searchParams).append("tab","following"),t.append("sort","newest"),t.append("page",p.toString()),[4,fetch(o.toString(),{signal:w})]):(console.debug("[".concat(scriptName,"] missing user id")),[2]);case 1:return(t=e.sent()).ok?(n=$,[4,t.text()]):(console.debug("[".concat(scriptName,"] failed to fetch page ").concat(p," of followed posts")),[2]);case 2:if(o=n.apply(void 0,[e.sent()]),!(r=o.find("a.s-post-summary--content-title[href*='/questions']").get()).length)return console.debug("[".concat(scriptName,"] last page reached")),[2];r=r.map(function(e){var e=__read(/\/questions\/(\d+)\/.*?(?:\/(\d+)|$)/.exec(e.href)||[],3),t=e[1],e=e[2];return{postId:e||t,type:e?"answer":"question"}}),r=r.filter(function(e){return"all"===v||v===e.type}),a=r.length,window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:a,page:p}})),s=StackExchange.options.user.fkey,e.label=3;case 3:e.trys.push([3,9,10,11]),i=__values(r),l=i.next(),e.label=4;case 4:return l.done?[3,8]:(c=l.value.postId,w.aborted?(console.debug("[".concat(scriptName,"] unfollowing aborted")),[2]):[4,unfollowPost(s,c,w)]);case 5:return e.sent(),unfollowedPostIdsCache.add(c),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:a,page:p,postId:c}})),[4,delay(500)];case 6:e.sent(),e.label=7;case 7:return l=i.next(),[3,4];case 8:return[3,11];case 9:return u=e.sent(),u={error:u},[3,11];case 10:try{l&&!l.done&&(f=i.return)&&f.call(i)}finally{if(u)throw u.error}return[7];case 11:return[4,delay(2001)];case 12:return e.sent(),[2,unfollowPosts(p+1,w,v)];case 13:return d=e.sent(),console.debug("[".concat(scriptName,"] failed to get page ").concat(p," of followed posts:\n").concat(d)),[3,14];case 14:return[2]}})})},followPosts=function(l,c){return __awaiter(void 0,void 0,void 0,function(){var t,o,n,r,a,s,i;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,10,,11]),t=StackExchange.options.user.fkey,e.label=1;case 1:e.trys.push([1,7,8,9]),o=__values(l),n=o.next(),e.label=2;case 2:return n.done?[3,6]:(r=n.value,[4,followPost(t,r,c)]);case 3:return e.sent()&&unfollowedPostIdsCache.delete(r),window.dispatchEvent(new CustomEvent("undo-progress-post",{detail:{postId:r}})),[4,delay(1e3)];case 4:e.sent(),e.label=5;case 5:return n=o.next(),[3,2];case 6:return[3,9];case 7:return s=e.sent(),s={error:s},[3,9];case 8:try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(s)throw s.error}return[7];case 9:return[2,!0];case 10:return a=e.sent(),console.debug("[".concat(scriptName,"] failed to bulk follow posts:\n").concat(a)),[2,!1];case 11:return[2]}})})},registerObserverIf=(unsafeWindow.addEventListener("userscript-configurer-load",function(){var e=((null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)||{}).Configurer;e?e.register(scriptName).options({"always-follow-questions":{desc:"Autofollow posts on page load"},"always-follow-answers":{desc:"Autofollow answers on page load"},"always-follow-upvotes":{desc:"Autofollow posts on voting up"},"always-follow-downvotes":{desc:"Autofollow posts on voting down"},"always-follow-close-votes":{desc:"Autofollow posts on voting to close"},"always-follow-flags":{desc:"Autofollow posts on flagging"},"always-follow-edits":{desc:"Autofollow posts on edit"},"always-follow-bookmarks":{desc:"Autofollow posts upon bookmarking"},"always-follow-comments":{desc:"Autofollow posts on commenting"},"reload-on-done":{desc:"Reload page after unfollowing all posts"}},{def:!1,direction:"left",type:"toggle"}):console.debug("[".concat(scriptName,"] missing userscript configurer"))}),function(e,t,o){for(var n=[],r=3;r<arguments.length;r++)n[r-3]=arguments[r];if(e)return console.debug("[".concat(scriptName,'] registered observer for "').concat(o,'"')),t.apply(void 0,__spreadArray([o],__read(n),!1))});window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var s,a,i,t,o,n,r,l,c,d,u,f,p,w,v,m,g,b,y,h,_;return __generator(this,function(e){switch(e.label){case 0:return(s=null==(_=null==(_=null==(_=unsafeWindow.UserScripters)?void 0:_.Userscripts)?void 0:_.Configurer)?void 0:_.get(scriptName),StackExchange.options.user.isAnonymous)?[3,2]:(a=new Map([["always-follow-questions",[registerFollowPostObserver,".js-follow-question"]],["always-follow-answers",[registerFollowPostObserver,".js-follow-answer"]],["always-follow-upvotes",[registerVoteObserver,".js-vote-up-btn"]],["always-follow-downvotes",[registerVoteObserver,".js-vote-down-btn"]],["always-follow-close-votes",[registerPopupObserver,"#popup-close-question .js-popup-submit","close-question"]],["always-follow-flags",[registerPopupObserver,"#popup-flag-post .js-popup-submit","flag-post"]],["always-follow-edits",[registerEditObserver,".inline-editor [id^='submit-button']"]],["always-follow-bookmarks",[registerVoteObserver,".js-bookmark-btn"]],["always-follow-comments",[registerCommentObserver,".js-comment-form-layout button[type=submit]"]]]),_=__spreadArray([],__read(a),!1).map(function(e){var e=__read(e,2),o=e[0],e=__read(e[1]),n=e[0],r=e[1],a=e.slice(2);return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,null==s?void 0:s.load(o)];case 1:return t=e.sent()||!1,[2,[o,registerObserverIf.apply(void 0,__spreadArray([t,n,r],__read(a),!1))]]}})})}),t=Map.bind,[4,Promise.all(_)]);case 1:i=new(t.apply(Map,[void 0,e.sent()])),window.addEventListener("userscript-configurer-change",function(e){var e=e.detail,t=e.name,e=e.value,o=a.get(t);if(o){var o=__read(o),n=o[0],r=o[1],o=o.slice(2);if(!e)return console.debug("[".concat(scriptName,'] disconnected observer for "').concat(r,'"')),void(null!=(e=i.get(t))&&e.disconnect());i.set(t,n.apply(void 0,__spreadArray([r],__read(o),!1))),console.debug("[".concat(scriptName,'] registered observer for "').concat(r,'"'))}}),e.label=2;case 2:return"following"===new URLSearchParams(location.search).get("tab")&&(_=document.querySelector("#user-tab-following > div:first-child"))&&(o=makeStacksButton("".concat(scriptName,"-unfollow-all-btn"),"Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"}),r=__read(makeStacksModal("".concat(scriptName,"-unfollow-all-modal"),"Unfollow All Posts",{minWidth:25}),2),n=r[0],r=r[1],(l=document.createElement("p")).innerHTML='\n            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>\n            The process is intentionally throttled to avoid rate-limiting.<br/>\n            If you still wish to proceed, click the "Start" button below.\n            '.trim(),(c=document.createElement("p")).innerHTML='\n            Until you reload the page, it is possible to undo the changes made so far by clicking the "Undo" button.\n            '.trim(),(d=document.createElement("div")).classList.add("d-flex","ai-center","gsx","g12"),u=makeStacksButton("".concat(scriptName,"-unfollow-all-start-btn"),"Start",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing all posts"}),f=makeStacksButton("".concat(scriptName,"-unfollow-q-start-btn"),"Start Qs",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing questions only"}),p=makeStacksButton("".concat(scriptName,"-unfollow-a-start-btn"),"Start As",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing answers only"}),w=makeStacksButton("".concat(scriptName,"-unfollow-all-undo-btn"),"Undo",{classes:["flex--item"],type:"outlined",title:"Start undoing unfollowing posts"}),v=makeStacksButton("".concat(scriptName,"-unfollow-all-abort-btn"),"Abort",{classes:["flex--item"],type:"outlined",title:"Abort the current operation immediately"}),(m=document.createElement("div")).classList.add("flex--item"),g=0,window.addEventListener("unfollow-progress-page",function(e){e=e.detail.page;m.textContent="Unfollowing page ".concat(e),g=0}),window.addEventListener("unfollow-progress-post",function(e){g+=1;var e=e.detail,t=e.numAnchors,e=e.page;m.textContent="Unfollowing page ".concat(e," (").concat(g,"/").concat(t,")")}),window.addEventListener("undo-progress-post",function(e){e=e.detail.postId;m.textContent="Followed post ".concat(e," (").concat(unfollowedPostIdsCache.size," left)")}),b=[u,f,p],h=function(t,o){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return y=new AbortController,w.disabled=!0,b.forEach(function(e){return e.disabled=!0}),t.classList.add("is-loading"),[4,unfollowPosts(1,y.signal,o)];case 1:return e.sent(),t.classList.remove("is-loading"),m.textContent="Finished unfollowing posts",b.forEach(function(e){return e.disabled=!1}),w.disabled=!1,[4,null==s?void 0:s.load("reload-on-done")];case 2:return e.sent()||!1?[4,delay(1e3)]:[3,4];case 3:e.sent(),location.reload(),e.label=4;case 4:return[2]}})})},u.addEventListener("click",function(){return h(u,"all")}),f.addEventListener("click",function(){return h(f,"question")}),p.addEventListener("click",function(){return h(p,"answer")}),w.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return y=new AbortController,u.disabled=!0,w.classList.add("is-loading"),[4,followPosts(unfollowedPostIdsCache,y.signal)];case 1:return e.sent(),w.classList.remove("is-loading"),u.disabled=!1,m.textContent="Finished refollowing posts",[2]}})})}),v.addEventListener("click",function(){return y.abort()}),o.addEventListener("click",function(){return Stacks.showModal(n)}),d.append.apply(d,__spreadArray(__spreadArray([],__read(b),!1),[w,v,m],!1)),r.append(l,c,d),_.append(o),document.body.append(n)),[2]}})})},{once:!0});