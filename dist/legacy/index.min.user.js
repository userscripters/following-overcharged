// ==UserScript==
// @name            Following Overcharged
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Various improvements to the "follow" feature
// @grant           unsafeWindow
// @homepage        https://github.com/userscripters/following-overcharged#readme
// @match           https://stackoverflow.com/questions/*
// @match           https://stackoverflow.com/users/*
// @match           https://serverfault.com/questions/*
// @match           https://serverfault.com/users/*
// @match           https://superuser.com/questions/*
// @match           https://superuser.com/users/*
// @match           https://*.stackexchange.com/questions/*
// @match           https://*.stackexchange.com/users/*
// @match           https://askubuntu.com/questions/*
// @match           https://askubuntu.com/users/*
// @match           https://stackapps.com/questions/*
// @match           https://stackapps.com/users/*
// @match           https://mathoverflow.net/questions/*
// @match           https://mathoverflow.net/users/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/users/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/users/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/users/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/users/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.stackoverflow.com/users/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.serverfault.com/users/*
// @match           https://meta.superuser.com/questions/*
// @match           https://meta.superuser.com/users/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.askubuntu.com/users/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.mathoverflow.net/users/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.meta.stackoverflow.com/users/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/users/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/users/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.meta.stackoverflow.com/users/*
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/following-overcharged.git
// @supportURL      https://github.com/userscripters/following-overcharged/issues
// @version         0.1.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,s,l,i){return new(l=l||Promise)(function(n,t){function o(e){try{r(i.next(e))}catch(e){t(e)}}function a(e){try{r(i.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?n(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(o,a)}r((i=i.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(o,a){var r,s,l,i={label:0,sent:function(){if(1&l[0])throw l[1];return l[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,s&&(l=2&t[0]?s.return:t[0]?s.throw||((l=s.return)&&l.call(s),0):s.next)&&!(l=l.call(s,t[1])).done)return l;switch(s=0,(t=l?[2&t[0],l.value]:t)[0]){case 0:case 1:l=t;break;case 4:return i.label++,{value:t[1],done:!1};case 5:i.label++,s=t[1],t=[0];continue;case 7:t=i.ops.pop(),i.trys.pop();continue;default:if(!(l=0<(l=i.trys).length&&l[l.length-1])&&(6===t[0]||2===t[0])){i=0;continue}if(3===t[0]&&(!l||t[1]>l[0]&&t[1]<l[3])){i.label=t[1];break}if(6===t[0]&&i.label<l[1]){i.label=l[1],l=t;break}if(l&&i.label<l[2]){i.label=l[2],i.ops.push(t);break}l[2]&&i.ops.pop(),i.trys.pop();continue}t=a.call(o,i)}catch(e){t=[6,e],s=0}finally{r=l=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,a,r=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(o=r.next()).done;)s.push(o.value)}catch(e){a={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(a)throw a.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var o,a=0,r=t.length;a<r;a++)!o&&a in t||((o=o||Array.prototype.slice.call(t,0,a))[a]=t[a]);return e.concat(o||Array.prototype.slice.call(t))},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&o>=e.length?void 0:e)&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},scriptName="following-overcharged",makeStacksButton=function(e,t,n){var o=(n=void 0===n?{}:n).classes,o=void 0===o?[]:o,a=n.title,r=n.danger,r=void 0!==r&&r,s=n.loading,s=void 0!==s&&s,l=n.muted,l=void 0!==l&&l,i=n.primary,i=void 0!==i&&i,n=n.type,n=void 0===n?"filled":n,c=document.createElement("button");return c.id=e,c.textContent=t,(e=c.classList).add.apply(e,__spreadArray(["s-btn","s-btn__".concat(n)],__read(o),!1)),c.setAttribute("role","button"),c.setAttribute("aria-label",a||t),r&&c.classList.add("s-btn__danger"),l&&c.classList.add("s-btn__muted"),i&&c.classList.add("s-btn__primary"),s&&c.classList.add("is-loading"),a&&(c.title=a),c},makeStacksIcon=function(e,t,n){var o=(n=void 0===n?{}:n).classes,o=void 0===o?[]:o,a=n.hidden,a=void 0!==a&&a,r=n.namespace,r=void 0===r?"http://www.w3.org/2000/svg":r,s=n.height,s=void 0===s?18:s,n=n.width,n=void 0===n?18:n,l=document.createElementNS(r,"svg"),i=((i=l.classList).add.apply(i,__spreadArray(["svg-icon",e],__read(o),!1)),l.setAttribute("width",n.toString()),l.setAttribute("height",s.toString()),l.setAttribute("viewBox","0 0 ".concat(n," ").concat(s)),l.setAttribute("aria-hidden","true"),a&&l.classList.add("d-none"),document.createElementNS(r,"path"));return i.setAttribute("d",t),l.append(i),l},makeStacksModal=function(e,t,n){var n=n.minWidth,o="modal-title",a=document.createElement("aside"),r=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",o),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a.dataset),r=(r.sModalTarget="modal",r.controller="s-modal",document.createElement("div")),n=(r.classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(n)),r.setAttribute("role","document"),r.id="".concat(e,"-document"),r.draggable=!0,document.createElement("h1")),e=(n.classList.add("s-modal--header"),n.id=o,n.textContent=t,document.createElement("button")),o=(e.classList.add("s-modal--close","s-btn","s-btn__muted"),e.type="button",e.dataset.action="s-modal#hide",makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14}));return e.append(o),r.append(n,e),a.append(r),[a,r]},observe=function(o,a,r){function e(e,t){var n=a.querySelectorAll(o);n.length&&r(__spreadArray([],__read(n),!1),t)}var t=new MutationObserver(e);t.observe(a,{attributes:!0,childList:!0,subtree:!0}),e(0,t)},delay=function(t){return void 0===t&&(t=100),new Promise(function(e){return setTimeout(e,t)})},normalizeDatasetPropName=function(e){return e.split("-").map(function(e,t){var e=__read(e),n=e[0],e=e.slice(1);return"".concat(t?n.toUpperCase():n.toLowerCase()).concat(e.join("").toLowerCase())}).join("")},followPost=function(o,a,r){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=new URL("".concat(location.origin,"/posts/").concat(a,"/vote/21")),(n=new URLSearchParams).set("fkey",o),[4,fetch(t.toString(),{body:n,credentials:"include",method:"POST",signal:r})];case 1:return[2,e.sent().ok]}})})},unfollowPost=function(o,a,r){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return(t=new URL("".concat(location.origin,"/posts/").concat(a,"/vote/21"))).searchParams.append("undo","true"),(n=new URLSearchParams).set("fkey",o),[4,fetch(t.toString(),{body:n,credentials:"include",method:"POST",signal:r})];case 1:return[2,e.sent().ok]}})})},followCount=0,registerFollowPostObserver=function(e){observe(e,document,function(d,u){return __awaiter(void 0,void 0,void 0,function(){var t,n,o,a,r,s,l,i,c;return __generator(this,function(e){switch(e.label){case 0:if(100<followCount)return console.debug("[".concat(scriptName,"] attempted to follow >= 100 posts, disconnecting")),u.disconnect(),[2];t=normalizeDatasetPropName("".concat(scriptName,"-state")),n=StackExchange.options.user.fkey,e.label=1;case 1:e.trys.push([1,8,9,10]),o=__values(d),a=o.next(),e.label=2;case 2:return a.done?[3,7]:"follow"===(r=a.value).dataset[t]?[3,6]:(c=null==(c=null==(c=r.textContent)?void 0:c.toLowerCase())?void 0:c.trim())?+(s=r.id.replace("btnFollowPost-",""))?"follow"!==c?[3,4]:(followCount+=1,[4,followPost(n,s)]):(console.debug("[".concat(scriptName,"] failed to get postId from follow button")),[3,6]):(console.debug("[".concat(scriptName,"] empty follow button found")),[3,6]);case 3:e.sent(),r.dataset[t]=c,r.textContent="Following",e.label=4;case 4:return[4,delay(250)];case 5:e.sent(),e.label=6;case 6:return a=o.next(),[3,2];case 7:return[3,10];case 8:return s=e.sent(),l={error:s},[3,10];case 9:try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(l)throw l.error}return[7];case 10:return[2]}})})})},unfollowAllPosts=function(w,g){return __awaiter(void 0,void 0,void 0,function(){var t,n,o,a,r,s,l,i,c,d,u,f,p;return __generator(this,function(e){switch(e.label){case 0:return(e.trys.push([0,13,,14]),n=StackExchange.options.user.userId)?(n=new URL("".concat(location.origin,"/users/").concat(n)),(t=n.searchParams).append("tab","following"),t.append("sort","newest"),t.append("page",w.toString()),[4,fetch(n.toString(),{signal:g})]):(console.debug("[".concat(scriptName,"] missing user id")),[2]);case 1:return(t=e.sent()).ok?(o=$,[4,t.text()]):(console.debug("[".concat(scriptName,"] failed to fetch page ").concat(w," of followed posts")),[2]);case 2:if(n=o.apply(void 0,[e.sent()]),!(a=n.find("a.s-post-summary--content-title[href*='/questions']").get()).length)return console.debug("[".concat(scriptName,"] last page reached")),[2];r=a.length,window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:r,page:w}})),s=StackExchange.options.user.fkey,e.label=3;case 3:e.trys.push([3,9,10,11]),l=__values(a),i=l.next(),e.label=4;case 4:return i.done?[3,8]:(d=i.value,g.aborted?(console.debug("[".concat(scriptName,"] unfollowing aborted")),[2]):(d=__read(/\/questions\/(\d+)\/.*?(?:\/(\d+)|$)/.exec(d.href)||[],3),c=d[1],d=d[2],[4,unfollowPost(s,c=d||c,g)]));case 5:return e.sent(),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:r,page:w,postId:c}})),[4,delay(250)];case 6:e.sent(),e.label=7;case 7:return i=l.next(),[3,4];case 8:return[3,11];case 9:return d=e.sent(),f={error:d},[3,11];case 10:try{i&&!i.done&&(p=l.return)&&p.call(l)}finally{if(f)throw f.error}return[7];case 11:return[4,delay(2001)];case 12:return e.sent(),[2,unfollowAllPosts(w+1,g)];case 13:return u=e.sent(),console.debug("[".concat(scriptName,"] failed to get page ").concat(w," of followed posts:\n").concat(u)),[3,14];case 14:return[2]}})})};unsafeWindow.addEventListener("userscript-configurer-load",function(){var e=((null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)||{}).Configurer;e?((e=e.register(scriptName)).option("always-follow-questions",{type:"toggle",desc:"Autofollow posts on page load",def:!1}),e.option("always-follow-answers",{type:"toggle",desc:"Autofollow answers on page load",def:!1}),e.option("reload-on-done",{type:"toggle",desc:"Reload page after unfollowing all posts",def:!1})):console.debug("[".concat(scriptName,"] missing userscript configurer"))}),window.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var t,n,o,a,r,s,l,i,c,d,u,f;return __generator(this,function(e){switch(e.label){case 0:return t=null==(f=null==(f=null==(f=unsafeWindow.UserScripters)?void 0:f.Userscripts)?void 0:f.Configurer)?void 0:f.get(scriptName),StackExchange.options.user.isAnonymous?[3,3]:[4,null==t?void 0:t.load("always-follow-questions")];case 1:return(e.sent()||!1)&&registerFollowPostObserver(".js-follow-question"),[4,null==t?void 0:t.load("always-follow-answers")];case 2:(e.sent()||!1)&&registerFollowPostObserver(".js-follow-answer"),e.label=3;case 3:return"following"===new URLSearchParams(location.search).get("tab")&&(f=document.querySelector("#user-tab-following > div:first-child"))&&(n=makeStacksButton("".concat(scriptName,"-unfollow-all-btn"),"Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"}),a=__read(makeStacksModal("".concat(scriptName,"-unfollow-all-modal"),"Unfollow All Posts",{minWidth:25}),2),o=a[0],a=a[1],(r=document.createElement("p")).innerHTML='\n            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>\n            The process is intentionally throttled to avoid rate-limiting.<br/>\n            If you still wish to proceed, click the "Start" button below.\n            '.trim(),(s=document.createElement("div")).classList.add("d-flex","ai-center","gsx","g12"),l=makeStacksButton("".concat(scriptName,"-unfollow-all-start-btn"),"Start",{classes:["flex--item"],danger:!0,type:"outlined"}),i=makeStacksButton("".concat(scriptName,"-unfollow-all-abort-btn"),"Abort",{classes:["flex--item"],type:"outlined"}),(c=document.createElement("div")).classList.add("flex--item"),d=0,window.addEventListener("unfollow-progress-page",function(e){e=e.detail.page;c.textContent="Unfollowing page ".concat(e),d=0}),window.addEventListener("unfollow-progress-post",function(e){d+=1;var e=e.detail,t=e.numAnchors,e=e.page;c.textContent="Unfollowing page ".concat(e," (").concat(d,"/").concat(t,")")}),u=new AbortController,l.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return l.classList.add("is-loading"),[4,unfollowAllPosts(1,u.signal)];case 1:return(e.sent(),l.classList.remove("is-loading"),c.textContent="Finished unfollowing posts",(null==t?void 0:t.load("reload-on-done"))||!1)?[4,delay(1e3)]:[3,3];case 2:e.sent(),location.reload(),e.label=3;case 3:return[2]}})})}),i.addEventListener("click",function(){return u.abort()}),n.addEventListener("click",function(){return Stacks.showModal(o)}),s.append(l,i,c),a.append(r,s),f.append(n),document.body.append(o)),[2]}})})},{once:!0});