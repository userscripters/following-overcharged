// ==UserScript==
// @name           Following Overcharged
// @author         Oleg Valter <oleg.a.valter@gmail.com>
// @description    Various improvements to the "follow" feature
// @grant          unsafeWindow
// @grant          GM_getValue
// @grant          GM_setValue
// @homepage       https://github.com/userscripters/following-overcharged#readme
// @match          https://stackoverflow.com/questions/*
// @match          https://stackoverflow.com/users/*
// @match          https://serverfault.com/questions/*
// @match          https://serverfault.com/users/*
// @match          https://superuser.com/questions/*
// @match          https://superuser.com/users/*
// @match          https://*.stackexchange.com/questions/*
// @match          https://*.stackexchange.com/users/*
// @match          https://askubuntu.com/questions/*
// @match          https://askubuntu.com/users/*
// @match          https://stackapps.com/questions/*
// @match          https://stackapps.com/users/*
// @match          https://mathoverflow.net/questions/*
// @match          https://mathoverflow.net/users/*
// @match          https://pt.stackoverflow.com/questions/*
// @match          https://pt.stackoverflow.com/users/*
// @match          https://ja.stackoverflow.com/questions/*
// @match          https://ja.stackoverflow.com/users/*
// @match          https://ru.stackoverflow.com/questions/*
// @match          https://ru.stackoverflow.com/users/*
// @match          https://es.stackoverflow.com/questions/*
// @match          https://es.stackoverflow.com/users/*
// @match          https://meta.stackoverflow.com/questions/*
// @match          https://meta.stackoverflow.com/users/*
// @match          https://meta.serverfault.com/questions/*
// @match          https://meta.serverfault.com/users/*
// @match          https://meta.superuser.com/questions/*
// @match          https://meta.superuser.com/users/*
// @match          https://meta.askubuntu.com/questions/*
// @match          https://meta.askubuntu.com/users/*
// @match          https://meta.mathoverflow.net/questions/*
// @match          https://meta.mathoverflow.net/users/*
// @match          https://pt.meta.stackoverflow.com/questions/*
// @match          https://pt.meta.stackoverflow.com/users/*
// @match          https://ja.meta.stackoverflow.com/questions/*
// @match          https://ja.meta.stackoverflow.com/users/*
// @match          https://ru.meta.stackoverflow.com/questions/*
// @match          https://ru.meta.stackoverflow.com/users/*
// @match          https://es.meta.stackoverflow.com/questions/*
// @match          https://es.meta.stackoverflow.com/users/*
// @namespace      userscripters
// @require        https://raw.githubusercontent.com/userscripters/storage/master/dist/browser.js
// @run-at         document-start
// @source         git+https://github.com/userscripters/following-overcharged.git
// @supportURL     https://github.com/userscripters/following-overcharged/issues
// @version        2.0.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,s,i,l){return new(i=i||Promise)(function(n,t){function o(e){try{a(l.next(e))}catch(e){t(e)}}function r(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?n(e.value):((t=e.value)instanceof i?t:new i(function(e){e(t)})).then(o,r)}a((l=l.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(o,r){var a,s,i,l={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,s&&(i=2&t[0]?s.return:t[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,t[1])).done)return i;switch(s=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,s=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(i=0<(i=l.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3]))l.label=t[1];else if(6===t[0]&&l.label<i[1])l.label=i[1],i=t;else{if(!(i&&l.label<i[2])){i[2]&&l.ops.pop(),l.trys.pop();continue}l.label=i[2],l.ops.push(t)}}t=r.call(o,l)}catch(e){t=[6,e],s=0}finally{a=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var o,r,a=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(o=a.next()).done;)s.push(o.value)}catch(e){r={error:e}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var o,r=0,a=t.length;r<a;r++)!o&&r in t||((o=o||Array.prototype.slice.call(t,0,r))[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&o>=e.length?void 0:e)&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},scriptName="following-overcharged",makeStacksButton=function(e,t,n){var o=(n=void 0===n?{}:n).classes,o=void 0===o?[]:o,r=n.title,a=n.danger,a=void 0!==a&&a,s=n.loading,s=void 0!==s&&s,i=n.muted,i=void 0!==i&&i,l=n.primary,l=void 0!==l&&l,n=n.type,n=void 0===n?"filled":n,c=document.createElement("button");return c.id=e,c.textContent=t,(e=c.classList).add.apply(e,__spreadArray(["s-btn","s-btn__".concat(n)],__read(o),!1)),c.setAttribute("role","button"),c.setAttribute("aria-label",r||t),a&&c.classList.add("s-btn__danger"),i&&c.classList.add("s-btn__muted"),l&&c.classList.add("s-btn__primary"),s&&c.classList.add("is-loading"),r&&(c.title=r),c},makeStacksIcon=function(e,t,n){var o=(n=void 0===n?{}:n).classes,o=void 0===o?[]:o,r=n.hidden,r=void 0!==r&&r,a=n.namespace,a=void 0===a?"http://www.w3.org/2000/svg":a,s=n.height,s=void 0===s?18:s,n=n.width,n=void 0===n?18:n,i=document.createElementNS(a,"svg"),l=((l=i.classList).add.apply(l,__spreadArray(["svg-icon",e],__read(o),!1)),i.setAttribute("width",n.toString()),i.setAttribute("height",s.toString()),i.setAttribute("viewBox","0 0 ".concat(n," ").concat(s)),i.setAttribute("aria-hidden","true"),r&&i.classList.add("d-none"),document.createElementNS(a,"path"));return l.setAttribute("d",t),i.append(l),i},makeDraggable=function(i){document.addEventListener("dragstart",function(e){var e=e.dataTransfer,t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});function t(e){var t,n,o,r,a=e.clientX,e=e.clientY,s=document.getElementById(i);s&&(l=l||a,c=c||e,t=(n=s.style).top,n=n.left,t||n||(t=(o=window.getComputedStyle(s)).top,n=o.left),[o=a-l,r=e-c].map(Math.abs).some(function(e){return 500<e})||((s=s.style).left="".concat(parseInt(n)+o,"px"),s.top="".concat(parseInt(t)+r,"px"),l=a,c=e))}var l=0,c=0,n=0,o=!1;document.addEventListener("dragstart",function(e){e.target===document.getElementById(i)&&(o=!0)}),document.addEventListener("dragend",function(e){e.target===document.getElementById(i)&&(o=!1,c=l=0)}),document.addEventListener("drag",function(e){if(!(3<=(n=e.clientX?0:n<3?n+1:3))&&o)return t(e)}),document.addEventListener("dragover",function(e){if(o&&e.preventDefault(),!(n<3)&&o)return t(e)})},makeStacksModal=function(e,t,n){var n=n.minWidth,o="modal-title",r=document.createElement("aside"),a=(r.classList.add("s-modal"),r.id=e,r.tabIndex=-1,r.setAttribute("role","dialog"),r.setAttribute("aria-labelledby",o),r.setAttribute("aria-describeddy","modal-description"),r.setAttribute("aria-hidden","true"),r.dataset),a=(a.sModalTarget="modal",a.controller="s-modal",document.createElement("div")),n=(a.classList.add("s-modal--dialog","ps-relative","hmx6","wmn".concat(n)),a.setAttribute("role","document"),a.id="".concat(e,"-document"),a.draggable=!0,document.createElement("h1")),e=(n.classList.add("s-modal--header"),n.id=o,n.textContent=t,document.createElement("button")),o=(e.classList.add("s-modal--close","s-btn","s-btn__muted"),e.type="button",e.dataset.action="s-modal#hide",makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14}));return makeDraggable(a.id),e.append(o),a.append(n,e),r.append(a),[r,a]},observe=function(o,r,a){function e(e,t){var n=r.querySelectorAll(o);n.length&&a(__spreadArray([],__read(n),!1),t)}var t=new MutationObserver(e);return t.observe(r,{attributes:!0,childList:!0,subtree:!0}),e(0,t),t},delay=function(t){return void 0===t&&(t=100),new Promise(function(e){return setTimeout(e,t)})},normalizeDatasetPropName=function(e){return e.split("-").map(function(e,t){var e=__read(e),n=e[0],e=e.slice(1);return"".concat(t?n.toUpperCase():n.toLowerCase()).concat(e.join("").toLowerCase())}).join("")},followPost=function(o,r,a){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=new URL("".concat(location.origin,"/posts/").concat(r,"/vote/21")),(n=new URLSearchParams).set("fkey",o),[4,fetch(t.toString(),{body:n,credentials:"include",method:"POST",signal:a})];case 1:return[2,e.sent().ok]}})})},unfollowPost=function(o,r,a){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return(t=new URL("".concat(location.origin,"/posts/").concat(r,"/vote/21"))).searchParams.append("undo","true"),(n=new URLSearchParams).set("fkey",o),[4,fetch(t.toString(),{body:n,credentials:"include",method:"POST",signal:a})];case 1:return[2,e.sent().ok]}})})},followCount=0,isElementNode=function(e){return e.nodeType===Node.ELEMENT_NODE},matches=function(e,t){return e.matches(t)},waitForAdded=function(o,e){return void 0===e&&(e=document),new Promise(function(n){new MutationObserver(function(e,t){e=e.flatMap(function(e){return __spreadArray([],__read(e.addedNodes),!1)}).filter(isElementNode).flatMap(function(e){return matches(e,o)?e:__spreadArray([],__read(e.querySelectorAll(o)),!1)});e.length&&(t.disconnect(),n(e))}).observe(e,{attributes:!0,childList:!0,subtree:!0})})},ObserverCleaner=function(){function e(){this.listeners=new Map,this.observers=new Set,this.statePropName=normalizeDatasetPropName("".concat(scriptName,"-state"))}return e.prototype.clean=function(){var e=this.observers,t=this.listeners,o=this.statePropName;e.forEach(function(e){return e.disconnect()}),t.forEach(function(e,t){var e=__read(e,2),n=e[0],e=e[1];t.removeEventListener(n,e),delete t.dataset[o]})},e.prototype.trackListener=function(e,t,n){return this.listeners.set(e,[t,n]),this},e.prototype.trackObserver=function(e){return this.observers.add(e),this},e}(),registerObserverIf=function(e,t,n){for(var o=[],r=3;r<arguments.length;r++)o[r-3]=arguments[r];if(e)return console.debug("[".concat(scriptName,'] registered observer for "').concat(n,'"')),t.apply(void 0,__spreadArray([n],__read(o),!1))},registerFollowPostObserver=function(e){var u=normalizeDatasetPropName("".concat(scriptName,"-state")),t=new ObserverCleaner,e=observe(e,document,function(c,d){return __awaiter(void 0,void 0,void 0,function(){var t,n,o,r,a,s,i,l;return __generator(this,function(e){switch(e.label){case 0:if(100<followCount)return console.debug("[".concat(scriptName,"] attempted to follow >= 100 posts, disconnecting")),d.disconnect(),[2];t=StackExchange.options.user.fkey,e.label=1;case 1:e.trys.push([1,8,9,10]),n=__values(c),o=n.next(),e.label=2;case 2:return o.done?[3,7]:"follow"===(r=o.value).dataset[u]?[3,6]:(l=null==(l=null==(l=r.textContent)?void 0:l.toLowerCase())?void 0:l.trim())?+(a=r.id.replace("btnFollowPost-",""))?"follow"!==l?[3,4]:(followCount+=1,[4,followPost(t,a)]):(console.debug("[".concat(scriptName,"] failed to get postId from follow button")),[3,6]):(console.debug("[".concat(scriptName,"] empty follow button found")),[3,6]);case 3:e.sent(),r.dataset[u]=l,r.textContent="Following",e.label=4;case 4:return[4,delay(500)];case 5:e.sent(),e.label=6;case 6:return o=n.next(),[3,2];case 7:return[3,10];case 8:return a=e.sent(),s={error:a},[3,10];case 9:try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(s)throw s.error}return[7];case 10:return[2]}})})});return t.trackObserver(e)},registerEditObserver=function(e){function s(e){var o=e.currentTarget;return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return+(t=null==o?void 0:o.id.replace("submit-button-",""))?[4,followPost(StackExchange.options.user.fkey,t)]:(console.debug("[".concat(scriptName,"] invalid post id: ").concat(t)),[2]);case 1:return e.sent(),[4,waitForAdded("#btnFollowPost-".concat(t),document)];case 2:return n=__read.apply(void 0,[e.sent(),1]),(n=n[0])&&(n.textContent="Following"),[2]}})})}var i=normalizeDatasetPropName("".concat(scriptName,"-state")),l=new ObserverCleaner,e=observe(e,document,function(e){var t,n;try{for(var o=__values(e),r=o.next();!r.done;r=o.next()){var a=r.value;"follow"!==a.dataset[i]&&(a.dataset[i]="follow",a.addEventListener("click",s),l.trackListener(a,"click",s))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}});return l.trackObserver(e)},registerVoteObserver=function(e){function s(e){var r=e.currentTarget;return __awaiter(void 0,void 0,void 0,function(){var t,n,o;return __generator(this,function(e){switch(e.label){case 0:return[4,delay(1e3)];case 1:return(e.sent(),"true"!==(o=r).getAttribute("aria-pressed"))?[2]:(t=o.closest(".question, .answer"))?(o=t.dataset,n=o.answerid,o=o.questionid,(n=n||o)?[4,followPost(StackExchange.options.user.fkey,n)]:(console.debug("[".concat(scriptName,"] missing post id")),[2])):(console.debug("[".concat(scriptName,"] missing post container")),[2]);case 2:return e.sent(),(o=t.querySelector(".js-follow-post"))&&(o.textContent="Following"),[2]}})})}var i=normalizeDatasetPropName("".concat(scriptName,"-state")),l=new ObserverCleaner,e=observe(e,document,function(e){var t,n;try{for(var o=__values(e),r=o.next();!r.done;r=o.next()){var a=r.value;"follow"!==a.dataset[i]&&(a.dataset[i]="follow",a.addEventListener("click",s),l.trackListener(a,"click",s))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}});return l.trackObserver(e)},registerPopupObserver=function(e,l){var c=normalizeDatasetPropName("".concat(scriptName,"-state")),d=new ObserverCleaner,e=observe(e,document,function(e){var t,n;try{for(var o=__values(e),r=o.next();!r.done;r=o.next()){var a=r.value;if("follow"!==a.dataset[c]){a.dataset[c]="follow";var s=a.closest("#popup-".concat(l));if(!s)return void console.debug("[".concat(scriptName,"] missing ").concat(l," popup dialog"));var i=function(o){return function(){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,delay(1e3)];case 1:return(e.sent(),t=o.dataset.postid)?[4,followPost(StackExchange.options.user.fkey,t)]:(console.debug("[".concat(scriptName,"] missing post id")),[2]);case 2:return e.sent(),(n=document.getElementById("btnFollowPost-".concat(t)))&&(n.textContent="Following"),[2]}})})}}(s);a.addEventListener("click",i),d.trackListener(a,"click",i)}}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}});return d.trackObserver(e)},registerCommentObserver=function(e){function s(e){var o=e.currentTarget;return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,delay(1e3)];case 1:return(e.sent(),n=o.closest("[id^='add-comment']"))?(t=n.id.replace("add-comment-",""),[4,followPost(StackExchange.options.user.fkey,t)]):(console.debug("[".concat(scriptName,"] missing comment form")),[2]);case 2:return e.sent(),(n=document.getElementById("btnFollowPost-".concat(t)))&&(n.textContent="Following"),[2]}})})}var i=normalizeDatasetPropName("".concat(scriptName,"-state")),l=new ObserverCleaner,e=observe(e,document,function(e){var t,n;try{for(var o=__values(e),r=o.next();!r.done;r=o.next()){var a=r.value;"follow"!==a.dataset[i]&&(a.dataset[i]="follow",a.addEventListener("click",s),l.trackListener(a,"click",s))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}});return l.trackObserver(e)},unfollowedPostIdsCache=new Set,unfollowPosts=function(p,v,w){return __awaiter(void 0,void 0,void 0,function(){var t,n,o,r,a,s,i,l,c,d,u,f;return __generator(this,function(e){switch(e.label){case 0:return(e.trys.push([0,13,,14]),n=StackExchange.options.user.userId)?(n=new URL("".concat(location.origin,"/users/").concat(n)),(t=n.searchParams).append("tab","following"),t.append("sort","newest"),t.append("page",p.toString()),[4,fetch(n.toString(),{signal:v})]):(console.debug("[".concat(scriptName,"] missing user id")),[2]);case 1:return(t=e.sent()).ok?(o=$,[4,t.text()]):(console.debug("[".concat(scriptName,"] failed to fetch page ").concat(p," of followed posts")),[2]);case 2:if(n=o.apply(void 0,[e.sent()]),!(r=n.find("a.s-post-summary--content-title[href*='/questions']").get()).length)return console.debug("[".concat(scriptName,"] last page reached")),[2];r=r.map(function(e){var e=__read(/\/questions\/(\d+)\/.*?(?:\/(\d+)|$)/.exec(e.href)||[],3),t=e[1],e=e[2];return{postId:e||t,type:e?"answer":"question"}}),r=r.filter(function(e){return"all"===w||w===e.type}),a=r.length,window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:a,page:p}})),s=StackExchange.options.user.fkey,e.label=3;case 3:e.trys.push([3,9,10,11]),i=__values(r),l=i.next(),e.label=4;case 4:return l.done?[3,8]:(c=l.value.postId,v.aborted?(console.debug("[".concat(scriptName,"] unfollowing aborted")),[2]):[4,unfollowPost(s,c,v)]);case 5:return e.sent(),unfollowedPostIdsCache.add(c),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:a,page:p,postId:c}})),[4,delay(500)];case 6:e.sent(),e.label=7;case 7:return l=i.next(),[3,4];case 8:return[3,11];case 9:return u=e.sent(),u={error:u},[3,11];case 10:try{l&&!l.done&&(f=i.return)&&f.call(i)}finally{if(u)throw u.error}return[7];case 11:return[4,delay(2001)];case 12:return e.sent(),[2,unfollowPosts(p+1,v,w)];case 13:return d=e.sent(),console.debug("[".concat(scriptName,"] failed to get page ").concat(p," of followed posts:\n").concat(d)),[3,14];case 14:return[2]}})})},followPosts=function(l,c){return __awaiter(void 0,void 0,void 0,function(){var t,n,o,r,a,s,i;return __generator(this,function(e){switch(e.label){case 0:e.trys.push([0,10,,11]),t=StackExchange.options.user.fkey,e.label=1;case 1:e.trys.push([1,7,8,9]),n=__values(l),o=n.next(),e.label=2;case 2:return o.done?[3,6]:(r=o.value,[4,followPost(t,r,c)]);case 3:return e.sent()&&unfollowedPostIdsCache.delete(r),window.dispatchEvent(new CustomEvent("undo-progress-post",{detail:{postId:r}})),[4,delay(1e3)];case 4:e.sent(),e.label=5;case 5:return o=n.next(),[3,2];case 6:return[3,9];case 7:return s=e.sent(),s={error:s},[3,9];case 8:try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(s)throw s.error}return[7];case 9:return[2,!0];case 10:return a=e.sent(),console.debug("[".concat(scriptName,"] failed to bulk follow posts:\n").concat(a)),[2,!1];case 11:return[2]}})})},makeObserverUpdater=function(a,s){return function(e){var t,n,e=e.detail,o=e.name,e=e.value,r=a.get(o);r&&(t=(r=__read(r))[0],n=r[1],r=r.slice(2),e?(s.set(o,t.apply(void 0,__spreadArray([n],__read(r),!1))),console.debug("[".concat(scriptName,'] registered observer for "').concat(n,'"'))):(console.debug("[".concat(scriptName,'] cleaned observer for "').concat(n,'"')),null!=(e=s.get(o))&&e.clean()))}},registerObservers=function(n,s){return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=Map.bind,[4,Promise.all(__spreadArray([],__read(n),!1).map(function(e){var e=__read(e,2),n=e[0],e=__read(e[1]),o=e[0],r=e[1],a=e.slice(2);return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,null==s?void 0:s.load(n)];case 1:return t=e.sent()||!1,[2,[n,registerObserverIf.apply(void 0,__spreadArray([t,o,r],__read(a),!1))]]}})})}))];case 1:return[2,new(t.apply(Map,[void 0,e.sent()]))]}})})},initScriptConfiguration=function(){var e=((null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)||{}).Configurer;if(e)return(e=e.register(scriptName,null==(e=window.Store)?void 0:e.locateStorage())).options({"always-follow-questions":{desc:"Autofollow posts on page load"},"always-follow-answers":{desc:"Autofollow answers on page load"},"always-follow-upvotes":{desc:"Autofollow posts on voting up"},"always-follow-downvotes":{desc:"Autofollow posts on voting down"},"always-follow-close-votes":{desc:"Autofollow posts on voting to close"},"always-follow-flags":{desc:"Autofollow posts on flagging"},"always-follow-edits":{desc:"Autofollow posts on edit"},"always-follow-bookmarks":{desc:"Autofollow posts upon bookmarking"},"always-follow-comments":{desc:"Autofollow posts on commenting"},"reload-on-done":{desc:"Reload page after unfollowing all posts"}},{def:!1,direction:"left",type:"toggle"}),e;console.debug("[".concat(scriptName,"] missing userscript configurer"))},initScript=function(){var n,o,e,t,r,a,s,i,l,c,d,u,f,p,v,w,m,g,b;StackExchange.options.user.isAnonymous||(n=new Map([["always-follow-questions",[registerFollowPostObserver,".js-follow-question"]],["always-follow-answers",[registerFollowPostObserver,".js-follow-answer"]],["always-follow-upvotes",[registerVoteObserver,".js-vote-up-btn"]],["always-follow-downvotes",[registerVoteObserver,".js-vote-down-btn"]],["always-follow-close-votes",[registerPopupObserver,"#popup-close-question .js-popup-submit","close-question"]],["always-follow-flags",[registerPopupObserver,"#popup-flag-post .js-popup-submit","flag-post"]],["always-follow-edits",[registerEditObserver,".inline-editor [id^='submit-button']"]],["always-follow-bookmarks",[registerVoteObserver,".js-bookmark-btn"]],["always-follow-comments",[registerCommentObserver,".js-comment-form-layout button[type=submit]"]]]),o=setInterval(function(){return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return(null==(t=null==(t=unsafeWindow.UserScripters)?void 0:t.Userscripts)?void 0:t.Configurer)?(t=initScriptConfiguration())?[4,registerObservers(n,t)]:[2]:[2];case 1:return t=e.sent(),window.addEventListener("userscript-configurer-change",makeObserverUpdater(n,t)),clearInterval(o),[2]}})})},50)),"following"===new URLSearchParams(location.search).get("tab")&&(e=document.querySelector("#user-tab-following > div:first-child"))&&(t=makeStacksButton("".concat(scriptName,"-unfollow-all-btn"),"Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"}),a=__read(makeStacksModal("".concat(scriptName,"-unfollow-all-modal"),"Unfollow All Posts",{minWidth:25}),2),r=a[0],a=a[1],(s=document.createElement("p")).innerHTML='\n            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>\n            The process is intentionally throttled to avoid rate-limiting.<br/>\n            If you still wish to proceed, click the "Start" button below.\n            '.trim(),(i=document.createElement("p")).innerHTML='\n            Until you reload the page, it is possible to undo the changes made so far by clicking the "Undo" button.\n            '.trim(),(l=document.createElement("div")).classList.add("d-flex","ai-center","gsx","g12"),c=makeStacksButton("".concat(scriptName,"-unfollow-all-start-btn"),"Start",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing all posts"}),d=makeStacksButton("".concat(scriptName,"-unfollow-q-start-btn"),"Start Qs",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing questions only"}),u=makeStacksButton("".concat(scriptName,"-unfollow-a-start-btn"),"Start As",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing answers only"}),f=makeStacksButton("".concat(scriptName,"-unfollow-all-undo-btn"),"Undo",{classes:["flex--item"],type:"outlined",title:"Start undoing unfollowing posts"}),p=makeStacksButton("".concat(scriptName,"-unfollow-all-abort-btn"),"Abort",{classes:["flex--item"],type:"outlined",title:"Abort the current operation immediately"}),(v=document.createElement("div")).classList.add("flex--item"),w=0,window.addEventListener("unfollow-progress-page",function(e){e=e.detail.page;v.textContent="Unfollowing page ".concat(e),w=0}),window.addEventListener("unfollow-progress-post",function(e){w+=1;var e=e.detail,t=e.numAnchors,e=e.page;v.textContent="Unfollowing page ".concat(e," (").concat(w,"/").concat(t,")")}),window.addEventListener("undo-progress-post",function(e){e=e.detail.postId;v.textContent="Followed post ".concat(e," (").concat(unfollowedPostIdsCache.size," left)")}),m=[c,d,u],b=function(n,o){return __awaiter(void 0,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return g=new AbortController,f.disabled=!0,m.forEach(function(e){return e.disabled=!0}),n.classList.add("is-loading"),[4,unfollowPosts(1,g.signal,o)];case 1:return e.sent(),n.classList.remove("is-loading"),v.textContent="Finished unfollowing posts",m.forEach(function(e){return e.disabled=!1}),f.disabled=!1,[4,null==(t=null==(t=null==(t=null==(t=unsafeWindow.UserScripters)?void 0:t.Userscripts)?void 0:t.Configurer)?void 0:t.get(scriptName))?void 0:t.load("reload-on-done")];case 2:return e.sent()||!1?[4,delay(1e3)]:[3,4];case 3:e.sent(),location.reload(),e.label=4;case 4:return[2]}})})},c.addEventListener("click",function(){return b(c,"all")}),d.addEventListener("click",function(){return b(d,"question")}),u.addEventListener("click",function(){return b(u,"answer")}),f.addEventListener("click",function(){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return g=new AbortController,c.disabled=!0,f.classList.add("is-loading"),[4,followPosts(unfollowedPostIdsCache,g.signal)];case 1:return e.sent(),f.classList.remove("is-loading"),c.disabled=!1,v.textContent="Finished refollowing posts",[2]}})})}),p.addEventListener("click",function(){return g.abort()}),t.addEventListener("click",function(){return Stacks.showModal(r)}),l.append.apply(l,__spreadArray(__spreadArray([],__read(m),!1),[f,p,v],!1)),a.append(s,i,l),e.append(t),document.body.append(r))};window.addEventListener("load",initScript,{once:!0});