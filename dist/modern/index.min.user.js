// ==UserScript==
// @name            Following Overcharged
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Various improvements to the "follow" feature
// @grant           unsafeWindow
// @homepage        https://github.com/userscripters/following-overcharged#readme
// @match           https://stackoverflow.com/questions/*
// @match           https://stackoverflow.com/users/*
// @match           https://serverfault.com/questions/*
// @match           https://serverfault.com/users/*
// @match           https://superuser.com/questions/*
// @match           https://superuser.com/users/*
// @match           https://*.stackexchange.com/questions/*
// @match           https://*.stackexchange.com/users/*
// @match           https://askubuntu.com/questions/*
// @match           https://askubuntu.com/users/*
// @match           https://stackapps.com/questions/*
// @match           https://stackapps.com/users/*
// @match           https://mathoverflow.net/questions/*
// @match           https://mathoverflow.net/users/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/users/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/users/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/users/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/users/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.stackoverflow.com/users/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.serverfault.com/users/*
// @match           https://meta.superuser.com/questions/*
// @match           https://meta.superuser.com/users/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.askubuntu.com/users/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.mathoverflow.net/users/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.meta.stackoverflow.com/users/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/users/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/users/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.meta.stackoverflow.com/users/*
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/following-overcharged.git
// @supportURL      https://github.com/userscripters/following-overcharged/issues
// @version         1.8.2
// ==/UserScript==

"use strict";const scriptName="following-overcharged",makeStacksButton=(e,t,o={})=>{var{classes:o=[],title:s,danger:a=!1,loading:n=!1,muted:l=!1,primary:i=!1,type:r="filled"}=o;const d=document.createElement("button");return d.id=e,d.textContent=t,d.classList.add("s-btn","s-btn__"+r,...o),d.setAttribute("role","button"),d.setAttribute("aria-label",s||t),a&&d.classList.add("s-btn__danger"),l&&d.classList.add("s-btn__muted"),i&&d.classList.add("s-btn__primary"),n&&d.classList.add("is-loading"),s&&(d.title=s),d},makeStacksIcon=(e,t,o={})=>{const{classes:s=[],hidden:a=!1,namespace:n="http://www.w3.org/2000/svg",height:l=18,width:i=18}=o,r=document.createElementNS(n,"svg"),d=(r.classList.add("svg-icon",e,...s),r.setAttribute("width",i.toString()),r.setAttribute("height",l.toString()),r.setAttribute("viewBox",`0 0 ${i} `+l),r.setAttribute("aria-hidden","true"),a&&r.classList.add("d-none"),document.createElementNS(n,"path"));return d.setAttribute("d",t),r.append(d),r},makeDraggable=t=>{document.addEventListener("dragstart",({dataTransfer:e})=>{const t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});let d=0,c=0,o=0,s=!1;const a=({clientX:o,clientY:s})=>{var a,n=document.getElementById(t);if(n){d=d||o,c=c||s;let{top:e,left:t}=n["style"];e||t||(a=window.getComputedStyle(n),e=a.top,t=a.left);const l=o-d,i=s-c;if(![l,i].map(Math.abs).some(e=>500<e)){const r=n["style"];r.left=parseInt(t)+l+"px",r.top=parseInt(e)+i+"px",d=o,c=s}}};document.addEventListener("dragstart",e=>{e=e.target;e===document.getElementById(t)&&(s=!0)}),document.addEventListener("dragend",({target:e})=>{e===document.getElementById(t)&&(s=!1,d=0,c=0)}),document.addEventListener("drag",e=>{if(!(3<=(o=e.clientX?0:o<3?o+1:3))&&s)return a(e)}),document.addEventListener("dragover",e=>{if(s&&e.preventDefault(),!(o<3)&&s)return a(e)})},makeStacksModal=(e,t,o)=>{var o=o["minWidth"],s="modal-title";const a=document.createElement("aside"),n=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",s),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a)["dataset"],l=(n.sModalTarget="modal",n.controller="s-modal",document.createElement("div")),i=(l.classList.add("s-modal--dialog","ps-relative","hmx6","wmn"+o),l.setAttribute("role","document"),l.id=e+"-document",l.draggable=!0,document.createElement("h1")),r=(i.classList.add("s-modal--header"),i.id=s,i.textContent=t,document.createElement("button"));r.classList.add("s-modal--close","s-btn","s-btn__muted"),r.type="button",r.dataset.action="s-modal#hide";o=makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14});return makeDraggable(l.id),r.append(o),l.append(i,r),a.append(l),[a,l]},observe=(s,a,n)=>{var e=(e,t)=>{var o=a.querySelectorAll(s);o.length&&n([...o],t)};const t=new MutationObserver(e);return t.observe(a,{attributes:!0,childList:!0,subtree:!0}),e(0,t),t},delay=(t=100)=>new Promise(e=>setTimeout(e,t)),normalizeDatasetPropName=e=>e.split("-").map(([e,...t],o)=>""+(o?e.toUpperCase():e.toLowerCase())+t.join("").toLowerCase()).join(""),followPost=async(e,t,o)=>{const s=new URL(location.origin+`/posts/${t}/vote/21`),a=new URLSearchParams;return a.set("fkey",e),(await fetch(s.toString(),{body:a,credentials:"include",method:"POST",signal:o})).ok},unfollowPost=async(e,t,o)=>{const s=new URL(location.origin+`/posts/${t}/vote/21`),a=(s.searchParams.append("undo","true"),new URLSearchParams);return a.set("fkey",e),(await fetch(s.toString(),{body:a,credentials:"include",method:"POST",signal:o})).ok};let followCount=0;const registerFollowPostObserver=e=>observe(e,document,async(e,t)=>{if(100<followCount)return console.debug(`[${scriptName}] attempted to follow >= 100 posts, disconnecting`),void t.disconnect();var o,s,a=normalizeDatasetPropName(scriptName+"-state"),n=StackExchange.options.user["fkey"];for(const l of e)"follow"!==l.dataset[a]&&((o=null==(o=null==(o=l.textContent)?void 0:o.toLowerCase())?void 0:o.trim())?+(s=l.id.replace("btnFollowPost-",""))?("follow"===o&&(followCount+=1,await followPost(n,s),l.dataset[a]=o,l.textContent="Following"),await delay(500)):console.debug(`[${scriptName}] failed to get postId from follow button`):console.debug(`[${scriptName}] empty follow button found`))}),isElementNode=e=>e.nodeType===Node.ELEMENT_NODE,matches=(e,t)=>e.matches(t),waitForAdded=(a,t=document)=>new Promise(s=>{const e=new MutationObserver((e,t)=>{const o=e.flatMap(e=>[...e.addedNodes]);e=o.filter(isElementNode).flatMap(e=>matches(e,a)?e:[...e.querySelectorAll(a)]);e.length&&(t.disconnect(),s(e))});e.observe(t,{attributes:!0,childList:!0,subtree:!0})}),registerEditObserver=e=>{const t=normalizeDatasetPropName(scriptName+"-edit-state");return observe(e,document,e=>{for(const o of e)"follow"!==o.dataset[t]&&(o.dataset[t]="follow",o.addEventListener("click",async()=>{var e=o.id.replace("submit-button-","");if(+e){await followPost(StackExchange.options.user.fkey,e);const[t]=await waitForAdded("#btnFollowPost-"+e,document);t&&(t.textContent="Following")}else console.debug(`[${scriptName}] invalid post id: `+e)}))})},registerVoteObserver=e=>{const t=normalizeDatasetPropName(scriptName+"-dv-state");return observe(e,document,e=>{for(const a of e)"follow"!==a.dataset[t]&&(a.dataset[t]="follow",a.addEventListener("click",async()=>{await delay(1e3);var e=a.getAttribute("aria-pressed");if("true"===e){const o=a.closest(".question, .answer");if(o){var{answerid:e,questionid:t}=o.dataset,e=e||t;if(e){await followPost(StackExchange.options.user.fkey,e);const s=o.querySelector(".js-follow-post");s&&(s.textContent="Following")}else console.debug(`[${scriptName}] missing post id`)}else console.debug(`[${scriptName}] missing post container`)}}))})},registerPopupObserver=(e,s)=>{const a=normalizeDatasetPropName(scriptName+"-vtc-state");return observe(e,document,e=>{for(const t of e)if("follow"!==t.dataset[a]){t.dataset[a]="follow";const o=t.closest("#popup-"+s);if(!o)return void console.debug(`[${scriptName}] missing ${s} popup dialog`);t.addEventListener("click",async()=>{await delay(1e3);var e=o.dataset["postid"];if(e){await followPost(StackExchange.options.user.fkey,e);const t=document.getElementById("btnFollowPost-"+e);t&&(t.textContent="Following")}else console.debug(`[${scriptName}] missing post id`)})}})},registerCommentObserver=e=>{const t=normalizeDatasetPropName(scriptName+"-comment-state");return observe(e,document,e=>{for(const s of e)"follow"!==s.dataset[t]&&(s.dataset[t]="follow",s.addEventListener("click",async()=>{await delay(1e3);const e=s.closest("[id^='add-comment']");if(e){var t=e.id.replace("add-comment-","");await followPost(StackExchange.options.user.fkey,t);const o=document.getElementById("btnFollowPost-"+t);o&&(o.textContent="Following")}else console.debug(`[${scriptName}] missing comment form`)}))})},unfollowedPostIdsCache=new Set,unfollowPosts=async(t,e,o)=>{try{var s=StackExchange.options.user["userId"];if(!s)return void console.debug(`[${scriptName}] missing user id`);const r=new URL(location.origin+"/users/"+s),d=r["searchParams"],c=(d.append("tab","following"),d.append("sort","newest"),d.append("page",t.toString()),await fetch(r.toString(),{signal:e}));if(!c.ok)return void console.debug(`[${scriptName}] failed to fetch page ${t} of followed posts`);const u=$(await c.text()),p=u.find("a.s-post-summary--content-title[href*='/questions']").get();if(!p.length)return void console.debug(`[${scriptName}] last page reached`);const w=p.map(e=>{var[,e,t]=/\/questions\/(\d+)\/.*?(?:\/(\d+)|$)/.exec(e.href)||[];return{postId:t||e,type:t?"answer":"question"}});var a,n=w.filter(e=>"all"===o||o===e.type),l=n.length,i=(window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:l,page:t}})),StackExchange.options.user)["fkey"];for({postId:a}of n){if(e.aborted)return void console.debug(`[${scriptName}] unfollowing aborted`);await unfollowPost(i,a,e),unfollowedPostIdsCache.add(a),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:l,page:t,postId:a}})),await delay(500)}return await delay(2001),unfollowPosts(t+1,e,o)}catch(e){console.debug(`[${scriptName}] failed to get page ${t} of followed posts:
`+e)}},followPosts=async(e,t)=>{try{var o=StackExchange.options.user["fkey"];for(const s of e)await followPost(o,s,t)&&unfollowedPostIdsCache.delete(s),window.dispatchEvent(new CustomEvent("undo-progress-post",{detail:{postId:s}})),await delay(1e3);return!0}catch(e){return console.debug(`[${scriptName}] failed to bulk follow posts:
`+e),!1}},registerObserverIf=(unsafeWindow.addEventListener("userscript-configurer-load",()=>{var e;const t=((null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)||{})["Configurer"];if(t){const o=t.register(scriptName);o.options({"always-follow-questions":{desc:"Autofollow posts on page load"},"always-follow-answers":{desc:"Autofollow answers on page load"},"always-follow-upvotes":{desc:"Autofollow posts on voting up"},"always-follow-downvotes":{desc:"Autofollow posts on voting down"},"always-follow-close-votes":{desc:"Autofollow posts on voting to close"},"always-follow-flags":{desc:"Autofollow posts on flagging"},"always-follow-edits":{desc:"Autofollow posts on edit"},"always-follow-bookmarks":{desc:"Autofollow posts upon bookmarking"},"always-follow-comments":{desc:"Autofollow posts on commenting"},"reload-on-done":{desc:"Reload page after unfollowing all posts"}},{def:!1,direction:"left",type:"toggle"})}else console.debug(`[${scriptName}] missing userscript configurer`)}),(e,t,o,...s)=>{if(e)return console.debug(`[${scriptName}] registered observer for "${o}"`),t(o,...s)});window.addEventListener("load",async()=>{const n=null==(e=null==(e=null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)?void 0:e.Configurer)?void 0:e.get(scriptName);if(!StackExchange.options.user.isAnonymous){const l=new Map([["always-follow-questions",[registerFollowPostObserver,".js-follow-question"]],["always-follow-answers",[registerFollowPostObserver,".js-follow-answer"]],["always-follow-upvotes",[registerVoteObserver,".js-vote-up-btn"]],["always-follow-downvotes",[registerVoteObserver,".js-vote-down-btn"]],["always-follow-close-votes",[registerPopupObserver,"#popup-close-question .js-popup-submit","close-question"]],["always-follow-flags",[registerPopupObserver,"#popup-flag-post .js-popup-submit","flag-post"]],["always-follow-edits",[registerEditObserver,".inline-editor [id^='submit-button']"]],["always-follow-bookmarks",[registerVoteObserver,".js-bookmark-btn"]],["always-follow-comments",[registerCommentObserver,".js-comment-form-layout button[type=submit]"]]]);var e=[...l].map(async([e,[t,o,...s]])=>{var a=await(null===n||void 0===n?void 0:n.load(e))||!1;return[e,registerObserverIf(a,t,o,...s)]});const i=new Map(await Promise.all(e));window.addEventListener("userscript-configurer-change",e=>{var e=e["detail"],{name:e,value:t}=e,o=l.get(e);if(o){const[s,a,...n]=o;if(!t)return console.debug(`[${scriptName}] disconnected observer for "${a}"`),void(null!=(o=i.get(e))&&o.disconnect());i.set(e,s(a,...n)),console.debug(`[${scriptName}] registered observer for "${a}"`)}})}const t=new URLSearchParams(location.search);if("following"===t.get("tab")){const a=document.querySelector("#user-tab-following > div:first-child");if(a){const r=makeStacksButton(scriptName+"-unfollow-all-btn","Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"}),[d,c]=makeStacksModal(scriptName+"-unfollow-all-modal","Unfollow All Posts",{minWidth:25}),u=document.createElement("p"),p=(u.innerHTML=`
            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>
            The process is intentionally throttled to avoid rate-limiting.<br/>
            If you still wish to proceed, click the "Start" button below.
            `.trim(),document.createElement("p")),w=(p.innerHTML=`
            Until you reload the page, it is possible to undo the changes made so far by clicking the "Undo" button.
            `.trim(),document.createElement("div")),m=(w.classList.add("d-flex","ai-center","gsx","g12"),makeStacksButton(scriptName+"-unfollow-all-start-btn","Start",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing all posts"})),f=makeStacksButton(scriptName+"-unfollow-q-start-btn","Start Qs",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing questions only"}),g=makeStacksButton(scriptName+"-unfollow-a-start-btn","Start As",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing answers only"}),b=makeStacksButton(scriptName+"-unfollow-all-undo-btn","Undo",{classes:["flex--item"],type:"outlined",title:"Start undoing unfollowing posts"}),v=makeStacksButton(scriptName+"-unfollow-all-abort-btn","Abort",{classes:["flex--item"],type:"outlined",title:"Abort the current operation immediately"}),y=document.createElement("div");y.classList.add("flex--item");let o=0;window.addEventListener("unfollow-progress-page",e=>{var e=e["detail"]["page"];y.textContent="Unfollowing page "+e,o=0}),window.addEventListener("unfollow-progress-post",e=>{o+=1;var{numAnchors:e,page:t}=e["detail"];y.textContent=`Unfollowing page ${t} (${o}/${e})`}),window.addEventListener("undo-progress-post",e=>{var e=e["detail"]["postId"];y.textContent=`Followed post ${e} (${unfollowedPostIdsCache.size} left)`});const h=[m,f,g];let s;const k=async(e,t)=>{s=new AbortController,b.disabled=!0,h.forEach(e=>e.disabled=!0),e.classList.add("is-loading"),await unfollowPosts(1,s.signal,t),e.classList.remove("is-loading"),y.textContent="Finished unfollowing posts",h.forEach(e=>e.disabled=!1),b.disabled=!1,!await(null===n||void 0===n?void 0:n.load("reload-on-done"))&&1||(await delay(1e3),location.reload())};m.addEventListener("click",()=>k(m,"all")),f.addEventListener("click",()=>k(f,"question")),g.addEventListener("click",()=>k(g,"answer")),b.addEventListener("click",async()=>{s=new AbortController,m.disabled=!0,b.classList.add("is-loading"),await followPosts(unfollowedPostIdsCache,s.signal),b.classList.remove("is-loading"),m.disabled=!1,y.textContent="Finished refollowing posts"}),v.addEventListener("click",()=>s.abort()),r.addEventListener("click",()=>Stacks.showModal(d)),w.append(...h,b,v,y),c.append(u,p,w),a.append(r),document.body.append(d)}}},{once:!0});