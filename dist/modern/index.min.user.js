// ==UserScript==
// @name           Following Overcharged
// @namespace      userscripters
// @version        2.0.1
// @author         Oleg Valter <oleg.a.valter@gmail.com>
// @description    Various improvements to the "follow" feature
// @license        GPL-3.0-or-later
// @match          https://stackoverflow.com/questions/*
// @match          https://stackoverflow.com/users/*
// @match          https://serverfault.com/questions/*
// @match          https://serverfault.com/users/*
// @match          https://superuser.com/questions/*
// @match          https://superuser.com/users/*
// @match          https://*.stackexchange.com/questions/*
// @match          https://*.stackexchange.com/users/*
// @match          https://meta.superuser.com/questions/*
// @match          https://meta.superuser.com/users/*
// @match          https://meta.serverfault.com/questions/*
// @match          https://meta.serverfault.com/users/*
// @match          https://askubuntu.com/questions/*
// @match          https://askubuntu.com/users/*
// @match          https://meta.askubuntu.com/questions/*
// @match          https://meta.askubuntu.com/users/*
// @match          https://stackapps.com/questions/*
// @match          https://stackapps.com/users/*
// @match          https://mathoverflow.net/questions/*
// @match          https://mathoverflow.net/users/*
// @match          https://meta.mathoverflow.net/questions/*
// @match          https://meta.mathoverflow.net/users/*
// @match          https://pt.stackoverflow.com/questions/*
// @match          https://pt.stackoverflow.com/users/*
// @match          https://pt.meta.stackoverflow.com/questions/*
// @match          https://pt.meta.stackoverflow.com/users/*
// @match          https://meta.stackoverflow.com/questions/*
// @match          https://meta.stackoverflow.com/users/*
// @match          https://ja.stackoverflow.com/questions/*
// @match          https://ja.stackoverflow.com/users/*
// @match          https://ja.meta.stackoverflow.com/questions/*
// @match          https://ja.meta.stackoverflow.com/users/*
// @match          https://ru.stackoverflow.com/questions/*
// @match          https://ru.stackoverflow.com/users/*
// @match          https://ru.meta.stackoverflow.com/questions/*
// @match          https://ru.meta.stackoverflow.com/users/*
// @match          https://es.stackoverflow.com/questions/*
// @match          https://es.stackoverflow.com/users/*
// @match          https://es.meta.stackoverflow.com/questions/*
// @match          https://es.meta.stackoverflow.com/users/*
// @require        https://raw.githubusercontent.com/userscripters/storage/master/dist/browser.js
// @grant          unsafeWindow
// @grant          GM_getValue
// @grant          GM_setValue
// @run-at         document-start
// @supportURL     https://github.com/userscripters/following-overcharged/issues
// @source         git+https://github.com/userscripters/following-overcharged.git
// @homepage       https://github.com/userscripters/following-overcharged#readme
// ==/UserScript==

let scriptName="following-overcharged",makeStacksButton=(e,t,o={})=>{var{classes:o=[],title:s,danger:a=!1,loading:r=!1,muted:l=!1,primary:n=!1,type:i="filled"}=o,d=document.createElement("button");return d.id=e,d.textContent=t,d.classList.add("s-btn","s-btn__"+i,...o),d.setAttribute("role","button"),d.setAttribute("aria-label",s||t),a&&d.classList.add("s-btn__danger"),l&&d.classList.add("s-btn__muted"),n&&d.classList.add("s-btn__primary"),r&&d.classList.add("is-loading"),s&&(d.title=s),d},makeStacksIcon=(e,t,o={})=>{var{classes:o=[],hidden:s=!1,namespace:a="http://www.w3.org/2000/svg",height:r=18,width:l=18}=o,n=document.createElementNS(a,"svg"),e=(n.classList.add("svg-icon",e,...o),n.setAttribute("width",l.toString()),n.setAttribute("height",r.toString()),n.setAttribute("viewBox",`0 0 ${l} `+r),n.setAttribute("aria-hidden","true"),s&&n.classList.add("d-none"),document.createElementNS(a,"path"));return e.setAttribute("d",t),n.append(e),n},makeDraggable=t=>{document.addEventListener("dragstart",({dataTransfer:e})=>{var t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});let n=0,i=0,o=0,s=!1,a=({clientX:o,clientY:s})=>{var a=document.getElementById(t);if(a){n=n||o,i=i||s;let{top:e,left:t}=a.style;e||t||(r=window.getComputedStyle(a),e=r.top,t=r.left);var r=o-n,l=s-i;[r,l].map(Math.abs).some(e=>500<e)||(a=a.style,a.left=parseInt(t)+r+"px",a.top=parseInt(e)+l+"px",n=o,i=s)}};document.addEventListener("dragstart",e=>{e=e.target;e===document.getElementById(t)&&(s=!0)}),document.addEventListener("dragend",({target:e})=>{e===document.getElementById(t)&&(s=!1,n=0,i=0)}),document.addEventListener("drag",e=>{if(!(3<=(o=e.clientX?0:o<3?o+1:3))&&s)return a(e)}),document.addEventListener("dragover",e=>{if(s&&e.preventDefault(),!(o<3)&&s)return a(e)})},makeStacksModal=(e,t,o)=>{var o=o.minWidth,s="modal-title",a=document.createElement("aside"),r=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",s),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a).dataset,r=(r.sModalTarget="modal",r.controller="s-modal",document.createElement("div")),o=(r.classList.add("s-modal--dialog","ps-relative","hmx6","wmn"+o),r.setAttribute("role","document"),r.id=e+"-document",r.draggable=!0,document.createElement("h1")),e=(o.classList.add("s-modal--header"),o.id=s,o.textContent=t,document.createElement("button")),s=(e.classList.add("s-modal--close","s-btn","s-btn__muted"),e.type="button",e.dataset.action="s-modal#hide",makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14}));return makeDraggable(r.id),e.append(s),r.append(o,e),a.append(r),[a,r]},observe=(s,a,r)=>{var e=(e,t)=>{var o=a.querySelectorAll(s);o.length&&r([...o],t)},t=new MutationObserver(e);return t.observe(a,{attributes:!0,childList:!0,subtree:!0}),e(0,t),t},delay=(t=100)=>new Promise(e=>setTimeout(e,t)),normalizeDatasetPropName=e=>e.split("-").map(([e,...t],o)=>""+(o?e.toUpperCase():e.toLowerCase())+t.join("").toLowerCase()).join(""),followPost=async(e,t,o)=>{var t=new URL(location.origin+`/posts/${t}/vote/21`),s=new URLSearchParams,e=(s.set("fkey",e),await fetch(t.toString(),{body:s,credentials:"include",method:"POST",signal:o}));return e.ok},unfollowPost=async(e,t,o)=>{var t=new URL(location.origin+`/posts/${t}/vote/21`),s=(t.searchParams.append("undo","true"),new URLSearchParams),e=(s.set("fkey",e),await fetch(t.toString(),{body:s,credentials:"include",method:"POST",signal:o}));return e.ok},followCount=0,isElementNode=e=>e.nodeType===Node.ELEMENT_NODE,matches=(e,t)=>e.matches(t),waitForAdded=(s,e=document)=>new Promise(o=>{new MutationObserver((e,t)=>{e=e.flatMap(e=>[...e.addedNodes]).filter(isElementNode).flatMap(e=>matches(e,s)?e:[...e.querySelectorAll(s)]);e.length&&(t.disconnect(),o(e))}).observe(e,{attributes:!0,childList:!0,subtree:!0})});class ObserverCleaner{constructor(){this.listeners=new Map,this.observers=new Set,this.statePropName=normalizeDatasetPropName(scriptName+"-state")}clean(){let{observers:e,listeners:t,statePropName:s}=this;e.forEach(e=>e.disconnect()),t.forEach(([e,t],o)=>{o.removeEventListener(e,t),delete o.dataset[s]})}trackListener(e,t,o){return this.listeners.set(e,[t,o]),this}trackObserver(e){return this.observers.add(e),this}}let registerObserverIf=(e,t,o,...s)=>{if(e)return console.debug(`[${scriptName}] registered observer for "${o}"`),t(o,...s)},registerFollowPostObserver=e=>{let l=normalizeDatasetPropName(scriptName+"-state");var t=new ObserverCleaner,e=observe(e,document,async(e,t)=>{if(100<followCount)console.debug(`[${scriptName}] attempted to follow >= 100 posts, disconnecting`),t.disconnect();else{var o,s,a,r=StackExchange.options.user.fkey;for(o of e)"follow"!==o.dataset[l]&&((s=null==(s=null==(s=o.textContent)?void 0:s.toLowerCase())?void 0:s.trim())?+(a=o.id.replace("btnFollowPost-",""))?("follow"===s&&(followCount+=1,await followPost(r,a),o.dataset[l]=s,o.textContent="Following"),await delay(500)):console.debug(`[${scriptName}] failed to get postId from follow button`):console.debug(`[${scriptName}] empty follow button found`))}});return t.trackObserver(e)},registerEditObserver=e=>{let o=normalizeDatasetPropName(scriptName+"-state"),s=new ObserverCleaner,a=async({currentTarget:e})=>{var t,e=null==e?void 0:e.id.replace("submit-button-","");+e?(await followPost(StackExchange.options.user.fkey,e),[t]=await waitForAdded("#btnFollowPost-"+e,document),t&&(t.textContent="Following")):console.debug(`[${scriptName}] invalid post id: `+e)};e=observe(e,document,e=>{for(var t of e)"follow"!==t.dataset[o]&&(t.dataset[o]="follow",t.addEventListener("click",a),s.trackListener(t,"click",a))});return s.trackObserver(e)},registerVoteObserver=e=>{let o=normalizeDatasetPropName(scriptName+"-state"),s=new ObserverCleaner,a=async({currentTarget:e})=>{await delay(1e3);var t,o;"true"===e.getAttribute("aria-pressed")&&((e=e.closest(".question, .answer"))?({answerid:t,questionid:o}=e.dataset,(t=t||o)?(await followPost(StackExchange.options.user.fkey,t),(o=e.querySelector(".js-follow-post"))&&(o.textContent="Following")):console.debug(`[${scriptName}] missing post id`)):console.debug(`[${scriptName}] missing post container`))};e=observe(e,document,e=>{for(var t of e)"follow"!==t.dataset[o]&&(t.dataset[o]="follow",t.addEventListener("click",a),s.trackListener(t,"click",a))});return s.trackObserver(e)},registerPopupObserver=(e,s)=>{let a=normalizeDatasetPropName(scriptName+"-state"),r=new ObserverCleaner;e=observe(e,document,e=>{for(var t of e)if("follow"!==t.dataset[a]){t.dataset[a]="follow";var o=t.closest("#popup-"+s);if(!o)return void console.debug(`[${scriptName}] missing ${s} popup dialog`);o=(t=>async()=>{await delay(1e3);var e=t.dataset.postid;e?(await followPost(StackExchange.options.user.fkey,e),(e=document.getElementById("btnFollowPost-"+e))&&(e.textContent="Following")):console.debug(`[${scriptName}] missing post id`)})(o);t.addEventListener("click",o),r.trackListener(t,"click",o)}});return r.trackObserver(e)},registerCommentObserver=e=>{let o=normalizeDatasetPropName(scriptName+"-state"),s=new ObserverCleaner,a=async({currentTarget:e})=>{await delay(1e3);var e=e.closest("[id^='add-comment']");e?(e=e.id.replace("add-comment-",""),await followPost(StackExchange.options.user.fkey,e),(e=document.getElementById("btnFollowPost-"+e))&&(e.textContent="Following")):console.debug(`[${scriptName}] missing comment form`)};e=observe(e,document,e=>{for(var t of e)"follow"!==t.dataset[o]&&(t.dataset[o]="follow",t.addEventListener("click",a),s.trackListener(t,"click",a))});return s.trackObserver(e)},unfollowedPostIdsCache=new Set,getFollowedPostsPage=async(e,t,o)=>{var e=new URL(location.origin+"/users/"+e),s=e.searchParams,s=(s.append("tab","following"),s.append("sort","newest"),s.append("page",t.toString()),await fetch(e.toString(),{signal:o}));return s.ok?$(await s.text()):(console.debug(`[${scriptName}] failed to fetch page ${t} of followed posts`),null)},getFollowedPostIds=(e,t)=>{var o,s=[];for(o of e.find(".js-post-summary[data-post-id][data-post-type-id]").get()){var{postId:a,postTypeId:r}=o.dataset;a&&r&&(r="2"===o.dataset.postTypeId?"answer":"question","all"!==t&&t!==r||s.push(a))}return s},unfollowPosts=async(t,e,o)=>{try{var s=StackExchange.options.user.userId;if(s){var a=await getFollowedPostsPage(s,t,e);if(a){var r=getFollowedPostIds(a,o);if(r.length){var l,n=r.length,i=(window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:n,page:t}})),StackExchange.options.user).fkey;for(l of r){if(e.aborted)return void console.debug(`[${scriptName}] unfollowing aborted`);await unfollowPost(i,l,e),unfollowedPostIdsCache.add(l),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:n,page:t,postId:l}})),await delay(500)}return await delay(2001),unfollowPosts(t+1,e,o)}console.debug(`[${scriptName}] last page reached`)}else console.debug(`[${scriptName}] missing followed posts page`)}else console.debug(`[${scriptName}] missing user id`)}catch(e){console.debug(`[${scriptName}] failed to get page ${t} of followed posts:
`+e)}},followPosts=async(e,t)=>{try{var o,s=StackExchange.options.user.fkey;for(o of e)await followPost(s,o,t)&&unfollowedPostIdsCache.delete(o),window.dispatchEvent(new CustomEvent("undo-progress-post",{detail:{postId:o}})),await delay(1e3);return!0}catch(e){return console.debug(`[${scriptName}] failed to bulk follow posts:
`+e),!1}},makeObserverUpdater=(r,l)=>e=>{var t,o,e=e.detail,{name:e,value:s}=e,a=r.get(e);a&&([a,t,...o]=a,s?(l.set(e,a(t,...o)),console.debug(`[${scriptName}] registered observer for "${t}"`)):(console.debug(`[${scriptName}] cleaned observer for "${t}"`),null!=(s=l.get(e))&&s.clean()))},registerObservers=async(e,r)=>new Map(await Promise.all([...e].map(async([e,[t,o,...s]])=>{var a=await(null==r?void 0:r.load(e))||!1;return[e,registerObserverIf(a,t,o,...s)]}))),initScriptConfiguration=()=>{var e=((null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)||{}).Configurer;if(e)return(e=e.register(scriptName,null==(e=window.Store)?void 0:e.locateStorage())).options({"always-follow-questions":{desc:"Autofollow posts on page load"},"always-follow-answers":{desc:"Autofollow answers on page load"},"always-follow-upvotes":{desc:"Autofollow posts on voting up"},"always-follow-downvotes":{desc:"Autofollow posts on voting down"},"always-follow-close-votes":{desc:"Autofollow posts on voting to close"},"always-follow-flags":{desc:"Autofollow posts on flagging"},"always-follow-edits":{desc:"Autofollow posts on edit"},"always-follow-bookmarks":{desc:"Autofollow posts upon bookmarking"},"always-follow-comments":{desc:"Autofollow posts on commenting"},"reload-on-done":{desc:"Reload page after unfollowing all posts"}},{def:!1,direction:"left",type:"toggle"}),e;console.debug(`[${scriptName}] missing userscript configurer`)},initScript=()=>{if(!StackExchange.options.user.isAnonymous){let t=new Map([["always-follow-questions",[registerFollowPostObserver,".js-follow-question"]],["always-follow-answers",[registerFollowPostObserver,".js-follow-answer"]],["always-follow-upvotes",[registerVoteObserver,".js-vote-up-btn"]],["always-follow-downvotes",[registerVoteObserver,".js-vote-down-btn"]],["always-follow-close-votes",[registerPopupObserver,"#popup-close-question .js-popup-submit","close-question"]],["always-follow-flags",[registerPopupObserver,"#popup-flag-post .js-popup-submit","flag-post"]],["always-follow-edits",[registerEditObserver,".inline-editor [id^='submit-button']"]],["always-follow-bookmarks",[registerVoteObserver,".js-bookmark-btn"]],["always-follow-comments",[registerCommentObserver,".js-comment-form-layout button[type=submit]"]]]),o=setInterval(async()=>{var e;(null==(e=null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)?void 0:e.Configurer)&&(e=initScriptConfiguration())&&(e=await registerObservers(t,e),window.addEventListener("userscript-configurer-change",makeObserverUpdater(t,e)),clearInterval(o))},50)}if("following"===new URLSearchParams(location.search).get("tab")){var u=document.querySelector("#user-tab-following > div:first-child");if(u){var p=makeStacksButton(scriptName+"-unfollow-all-btn","Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"});let[e,t]=makeStacksModal(scriptName+"-unfollow-all-modal","Unfollow All Posts",{minWidth:25});var w=document.createElement("p"),m=(w.innerHTML=`
            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>
            The process is intentionally throttled to avoid rate-limiting.<br/>
            If you still wish to proceed, click the "Start" button below.
            `.trim(),document.createElement("p")),g=(m.innerHTML=`
            Until you reload the page, it is possible to undo the changes made so far by clicking the "Undo" button.
            `.trim(),document.createElement("div"));g.classList.add("d-flex","ai-center","gsx","g12");let o=makeStacksButton(scriptName+"-unfollow-all-start-btn","Start",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing all posts"}),s=makeStacksButton(scriptName+"-unfollow-q-start-btn","Start Qs",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing questions only"}),a=makeStacksButton(scriptName+"-unfollow-a-start-btn","Start As",{classes:["flex--item"],danger:!0,type:"outlined",title:"Start unfollowing answers only"}),r=makeStacksButton(scriptName+"-unfollow-all-undo-btn","Undo",{classes:["flex--item"],type:"outlined",title:"Start undoing unfollowing posts"});var f=makeStacksButton(scriptName+"-unfollow-all-abort-btn","Abort",{classes:["flex--item"],type:"outlined",title:"Abort the current operation immediately"});let l=document.createElement("div"),n=(l.classList.add("flex--item"),0),i=(window.addEventListener("unfollow-progress-page",e=>{var e=e.detail.page;l.textContent="Unfollowing page "+e,n=0}),window.addEventListener("unfollow-progress-post",e=>{n+=1;var{numAnchors:e,page:t}=e.detail;l.textContent=`Unfollowing page ${t} (${n}/${e})`}),window.addEventListener("undo-progress-post",e=>{var e=e.detail.postId;l.textContent=`Followed post ${e} (${unfollowedPostIdsCache.size} left)`}),[o,s,a]),d,c=async(e,t)=>{d=new AbortController,r.disabled=!0,i.forEach(e=>e.disabled=!0),e.classList.add("is-loading"),await unfollowPosts(1,d.signal,t),e.classList.remove("is-loading"),l.textContent="Finished unfollowing posts",i.forEach(e=>e.disabled=!1),r.disabled=!1;t=await(null==(e=null==(t=null==(e=null==(t=unsafeWindow.UserScripters)?void 0:t.Userscripts)?void 0:e.Configurer)?void 0:t.get(scriptName))?void 0:e.load("reload-on-done"))||!1;t&&(await delay(1e3),location.reload())};o.addEventListener("click",()=>c(o,"all")),s.addEventListener("click",()=>c(s,"question")),a.addEventListener("click",()=>c(a,"answer")),r.addEventListener("click",async()=>{d=new AbortController,o.disabled=!0,r.classList.add("is-loading"),await followPosts(unfollowedPostIdsCache,d.signal),r.classList.remove("is-loading"),o.disabled=!1,l.textContent="Finished refollowing posts"}),f.addEventListener("click",()=>d.abort()),p.addEventListener("click",()=>Stacks.showModal(e)),g.append(...i,r,f,l),t.append(w,m,g),u.append(p),document.body.append(e)}}};window.addEventListener("load",initScript,{once:!0});