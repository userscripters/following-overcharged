// ==UserScript==
// @name            Following Overcharged
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Various improvements to the "follow" feature
// @grant           unsafeWindow
// @homepage        https://github.com/userscripters/following-overcharged#readme
// @match           https://stackoverflow.com/questions/*
// @match           https://stackoverflow.com/users/*
// @match           https://serverfault.com/questions/*
// @match           https://serverfault.com/users/*
// @match           https://superuser.com/questions/*
// @match           https://superuser.com/users/*
// @match           https://*.stackexchange.com/questions/*
// @match           https://*.stackexchange.com/users/*
// @match           https://askubuntu.com/questions/*
// @match           https://askubuntu.com/users/*
// @match           https://stackapps.com/questions/*
// @match           https://stackapps.com/users/*
// @match           https://mathoverflow.net/questions/*
// @match           https://mathoverflow.net/users/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/users/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/users/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/users/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/users/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.stackoverflow.com/users/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.serverfault.com/users/*
// @match           https://meta.superuser.com/questions/*
// @match           https://meta.superuser.com/users/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.askubuntu.com/users/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.mathoverflow.net/users/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.meta.stackoverflow.com/users/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/users/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/users/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.meta.stackoverflow.com/users/*
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/following-overcharged.git
// @supportURL      https://github.com/userscripters/following-overcharged/issues
// @version         1.4.0
// ==/UserScript==

"use strict";const scriptName="following-overcharged",makeStacksButton=(e,t,o={})=>{var{classes:o=[],title:s,danger:a=!1,loading:n=!1,muted:l=!1,primary:i=!1,type:d="filled"}=o;const r=document.createElement("button");return r.id=e,r.textContent=t,r.classList.add("s-btn","s-btn__"+d,...o),r.setAttribute("role","button"),r.setAttribute("aria-label",s||t),a&&r.classList.add("s-btn__danger"),l&&r.classList.add("s-btn__muted"),i&&r.classList.add("s-btn__primary"),n&&r.classList.add("is-loading"),s&&(r.title=s),r},makeStacksIcon=(e,t,o={})=>{const{classes:s=[],hidden:a=!1,namespace:n="http://www.w3.org/2000/svg",height:l=18,width:i=18}=o,d=document.createElementNS(n,"svg"),r=(d.classList.add("svg-icon",e,...s),d.setAttribute("width",i.toString()),d.setAttribute("height",l.toString()),d.setAttribute("viewBox",`0 0 ${i} `+l),d.setAttribute("aria-hidden","true"),a&&d.classList.add("d-none"),document.createElementNS(n,"path"));return r.setAttribute("d",t),d.append(r),d},makeDraggable=t=>{document.addEventListener("dragstart",({dataTransfer:e})=>{const t=document.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});let r=0,c=0,o=0,s=!1;const a=({clientX:o,clientY:s})=>{var a,n=document.getElementById(t);if(n){r=r||o,c=c||s;let{top:e,left:t}=n["style"];e||t||(a=window.getComputedStyle(n),e=a.top,t=a.left);const l=o-r,i=s-c;if(![l,i].map(Math.abs).some(e=>500<e)){const d=n["style"];d.left=parseInt(t)+l+"px",d.top=parseInt(e)+i+"px",r=o,c=s}}};document.addEventListener("dragstart",e=>{e=e.target;e===document.getElementById(t)&&(s=!0)}),document.addEventListener("dragend",({target:e})=>{e===document.getElementById(t)&&(s=!1,r=0,c=0)}),document.addEventListener("drag",e=>{if(!(3<=(o=e.clientX?0:o<3?o+1:3))&&s)return a(e)}),document.addEventListener("dragover",e=>{if(s&&e.preventDefault(),!(o<3)&&s)return a(e)})},makeStacksModal=(e,t,o)=>{var o=o["minWidth"],s="modal-title";const a=document.createElement("aside"),n=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",s),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a)["dataset"],l=(n.sModalTarget="modal",n.controller="s-modal",document.createElement("div")),i=(l.classList.add("s-modal--dialog","ps-relative","hmx6","wmn"+o),l.setAttribute("role","document"),l.id=e+"-document",l.draggable=!0,document.createElement("h1")),d=(i.classList.add("s-modal--header"),i.id=s,i.textContent=t,document.createElement("button"));d.classList.add("s-modal--close","s-btn","s-btn__muted"),d.type="button",d.dataset.action="s-modal#hide";o=makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14});return makeDraggable(l.id),d.append(o),l.append(i,d),a.append(l),[a,l]},observe=(s,a,n)=>{var e=(e,t)=>{var o=a.querySelectorAll(s);o.length&&n([...o],t)};const t=new MutationObserver(e);t.observe(a,{attributes:!0,childList:!0,subtree:!0}),e(0,t)},delay=(t=100)=>new Promise(e=>setTimeout(e,t)),normalizeDatasetPropName=e=>e.split("-").map(([e,...t],o)=>""+(o?e.toUpperCase():e.toLowerCase())+t.join("").toLowerCase()).join(""),followPost=async(e,t,o)=>{const s=new URL(location.origin+`/posts/${t}/vote/21`),a=new URLSearchParams;return a.set("fkey",e),(await fetch(s.toString(),{body:a,credentials:"include",method:"POST",signal:o})).ok},unfollowPost=async(e,t,o)=>{const s=new URL(location.origin+`/posts/${t}/vote/21`),a=(s.searchParams.append("undo","true"),new URLSearchParams);return a.set("fkey",e),(await fetch(s.toString(),{body:a,credentials:"include",method:"POST",signal:o})).ok};let followCount=0;const registerFollowPostObserver=e=>{observe(e,document,async(e,t)=>{if(100<followCount)return console.debug(`[${scriptName}] attempted to follow >= 100 posts, disconnecting`),void t.disconnect();var o,s,a=normalizeDatasetPropName(scriptName+"-state"),n=StackExchange.options.user["fkey"];for(const l of e)"follow"!==l.dataset[a]&&((o=null==(o=null==(o=l.textContent)?void 0:o.toLowerCase())?void 0:o.trim())?+(s=l.id.replace("btnFollowPost-",""))?("follow"===o&&(followCount+=1,await followPost(n,s),l.dataset[a]=o,l.textContent="Following"),await delay(500)):console.debug(`[${scriptName}] failed to get postId from follow button`):console.debug(`[${scriptName}] empty follow button found`))})},registerEditObserver=e=>{const t=normalizeDatasetPropName(scriptName+"-edit-state");observe(e,document,e=>{const o=StackExchange.options.user["fkey"];for(const s of e)"follow"!==s.dataset[t]&&(s.dataset[t]="follow",s.addEventListener("click",async()=>{var e=s.id.replace("submit-button-","");if(+e){await followPost(o,e);const t=document.getElementById("btnFollowPost-"+e);t&&(t.textContent="Following")}else console.debug(`[${scriptName}] invalid post id: `+e)}))})},registerVoteObserver=e=>{const t=normalizeDatasetPropName(scriptName+"-dv-state");observe(e,document,e=>{const a=StackExchange.options.user["fkey"];for(const n of e)"follow"!==n.dataset[t]&&(n.dataset[t]="follow",n.addEventListener("click",async()=>{await delay(1e3);var e=n.getAttribute("aria-pressed");if("true"===e){const o=n.closest(".question, .answer");if(o){var{answerid:e,questionid:t}=o.dataset,e=e||t;if(e){await followPost(a,e);const s=o.querySelector(".js-follow-post");s&&(s.textContent="Following")}else console.debug(`[${scriptName}] missing post id`)}else console.debug(`[${scriptName}] missing post container`)}}))})},unfollowedPostIdsCache=new Set,unfollowAllPosts=async(t,e)=>{try{var o=StackExchange.options.user["userId"];if(!o)return void console.debug(`[${scriptName}] missing user id`);const r=new URL(location.origin+"/users/"+o),c=r["searchParams"],u=(c.append("tab","following"),c.append("sort","newest"),c.append("page",t.toString()),await fetch(r.toString(),{signal:e}));if(!u.ok)return void console.debug(`[${scriptName}] failed to fetch page ${t} of followed posts`);const w=$(await u.text());var s=w.find("a.s-post-summary--content-title[href*='/questions']").get();if(!s.length)return void console.debug(`[${scriptName}] last page reached`);var a=s.length,n=(window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:a,page:t}})),StackExchange.options.user)["fkey"];for(const p of s){if(e.aborted)return void console.debug(`[${scriptName}] unfollowing aborted`);var[,l,i]=/\/questions\/(\d+)\/.*?(?:\/(\d+)|$)/.exec(p.href)||[],d=i||l;await unfollowPost(n,d,e),unfollowedPostIdsCache.add(d),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:a,page:t,postId:d}})),await delay(500)}return await delay(2001),unfollowAllPosts(t+1,e)}catch(e){console.debug(`[${scriptName}] failed to get page ${t} of followed posts:
`+e)}},followPosts=async(e,t)=>{try{var o=StackExchange.options.user["fkey"];for(const s of e)await followPost(o,s,t)&&unfollowedPostIdsCache.delete(s),window.dispatchEvent(new CustomEvent("undo-progress-post",{detail:{postId:s}})),await delay(1e3);return!0}catch(e){return console.debug(`[${scriptName}] failed to bulk follow posts:
`+e),!1}};unsafeWindow.addEventListener("userscript-configurer-load",()=>{const e=((null==(t=unsafeWindow.UserScripters)?void 0:t.Userscripts)||{})["Configurer"];if(e){const o=e.register(scriptName);var t={def:!1,direction:"left",type:"toggle"};o.option("always-follow-questions",{...t,desc:"Autofollow posts on page load"}),o.option("always-follow-answers",{...t,desc:"Autofollow answers on page load"}),o.option("always-follow-upvotes",{...t,desc:"Autofollow posts on voting up"}),o.option("always-follow-downvotes",{...t,desc:"Autofollow posts on voting down"}),o.option("always-follow-edits",{...t,desc:"Autofollow posts on edit"}),o.option("always-follow-bookmarks",{...t,desc:"Autofollow posts upon bookmarking"}),o.option("reload-on-done",{...t,desc:"Reload page after unfollowing all posts"})}else console.debug(`[${scriptName}] missing userscript configurer`)}),window.addEventListener("load",async()=>{var e;const t=null==(e=null==(e=null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)?void 0:e.Configurer)?void 0:e.get(scriptName),o=(StackExchange.options.user.isAnonymous||(await(null===t||void 0===t?void 0:t.load("always-follow-questions"))&&registerFollowPostObserver(".js-follow-question"),(await(null===t||void 0===t?void 0:t.load("always-follow-answers"))||!1)&&registerFollowPostObserver(".js-follow-answer"),(await(null===t||void 0===t?void 0:t.load("always-follow-upvotes"))||!1)&&registerVoteObserver(".js-vote-up-btn"),(await(null===t||void 0===t?void 0:t.load("always-follow-downvotes"))||!1)&&registerVoteObserver(".js-vote-down-btn"),(await(null===t||void 0===t?void 0:t.load("always-follow-edits"))||!1)&&registerEditObserver(".inline-editor [id^='submit-button']"),(await(null===t||void 0===t?void 0:t.load("always-follow-bookmarks"))||!1)&&registerVoteObserver(".js-bookmark-btn")),new URLSearchParams(location.search));if("following"===o.get("tab")){const s=document.querySelector("#user-tab-following > div:first-child");if(s){const a=makeStacksButton(scriptName+"-unfollow-all-btn","Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"}),[n,l]=makeStacksModal(scriptName+"-unfollow-all-modal","Unfollow All Posts",{minWidth:25}),i=document.createElement("p"),d=(i.innerHTML=`
            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>
            The process is intentionally throttled to avoid rate-limiting.<br/>
            If you still wish to proceed, click the "Start" button below.
            `.trim(),document.createElement("p")),r=(d.innerHTML=`
            Until you reload the page, it is possible to undo the changes made so far by clicking the "Undo" button.
            `.trim(),document.createElement("div")),c=(r.classList.add("d-flex","ai-center","gsx","g12"),makeStacksButton(scriptName+"-unfollow-all-start-btn","Start",{classes:["flex--item"],danger:!0,type:"outlined"})),u=makeStacksButton(scriptName+"-unfollow-all-undo-btn","Undo",{classes:["flex--item"],type:"outlined"}),w=makeStacksButton(scriptName+"-unfollow-all-abort-btn","Abort",{classes:["flex--item"],type:"outlined"}),p=document.createElement("div");p.classList.add("flex--item");let o=0;window.addEventListener("unfollow-progress-page",e=>{var e=e["detail"]["page"];p.textContent="Unfollowing page "+e,o=0}),window.addEventListener("unfollow-progress-post",e=>{o+=1;var{numAnchors:e,page:t}=e["detail"];p.textContent=`Unfollowing page ${t} (${o}/${e})`}),window.addEventListener("undo-progress-post",e=>{var e=e["detail"]["postId"];p.textContent=`Followed post ${e} (${unfollowedPostIdsCache.size} left)`});let e;c.addEventListener("click",async()=>{e=new AbortController,u.disabled=!0,c.classList.add("is-loading"),await unfollowAllPosts(1,e.signal),c.classList.remove("is-loading"),p.textContent="Finished unfollowing posts",u.disabled=!1,!await(null===t||void 0===t?void 0:t.load("reload-on-done"))&&1||(await delay(1e3),location.reload())}),u.addEventListener("click",async()=>{e=new AbortController,c.disabled=!0,u.classList.add("is-loading"),await followPosts(unfollowedPostIdsCache,e.signal),u.classList.remove("is-loading"),c.disabled=!1,p.textContent="Finished refollowing posts"}),w.addEventListener("click",()=>e.abort()),a.addEventListener("click",()=>Stacks.showModal(n)),r.append(c,u,w,p),l.append(i,d,r),s.append(a),document.body.append(n)}}},{once:!0});