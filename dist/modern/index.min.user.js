// ==UserScript==
// @name            Following Overcharged
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Various improvements to the "follow" feature
// @grant           unsafeWindow
// @homepage        https://github.com/userscripters/following-overcharged#readme
// @match           https://stackoverflow.com/questions/*
// @match           https://stackoverflow.com/users/*
// @match           https://serverfault.com/questions/*
// @match           https://serverfault.com/users/*
// @match           https://superuser.com/questions/*
// @match           https://superuser.com/users/*
// @match           https://*.stackexchange.com/questions/*
// @match           https://*.stackexchange.com/users/*
// @match           https://askubuntu.com/questions/*
// @match           https://askubuntu.com/users/*
// @match           https://stackapps.com/questions/*
// @match           https://stackapps.com/users/*
// @match           https://mathoverflow.net/questions/*
// @match           https://mathoverflow.net/users/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://pt.stackoverflow.com/users/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/users/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/users/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://es.stackoverflow.com/users/*
// @match           https://meta.stackoverflow.com/questions/*
// @match           https://meta.stackoverflow.com/users/*
// @match           https://meta.serverfault.com/questions/*
// @match           https://meta.serverfault.com/users/*
// @match           https://meta.superuser.com/questions/*
// @match           https://meta.superuser.com/users/*
// @match           https://meta.askubuntu.com/questions/*
// @match           https://meta.askubuntu.com/users/*
// @match           https://meta.mathoverflow.net/questions/*
// @match           https://meta.mathoverflow.net/users/*
// @match           https://pt.meta.stackoverflow.com/questions/*
// @match           https://pt.meta.stackoverflow.com/users/*
// @match           https://ja.meta.stackoverflow.com/questions/*
// @match           https://ja.meta.stackoverflow.com/users/*
// @match           https://ru.meta.stackoverflow.com/questions/*
// @match           https://ru.meta.stackoverflow.com/users/*
// @match           https://es.meta.stackoverflow.com/questions/*
// @match           https://es.meta.stackoverflow.com/users/*
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/following-overcharged.git
// @supportURL      https://github.com/userscripters/following-overcharged/issues
// @version         1.2.0
// ==/UserScript==

"use strict";const scriptName="following-overcharged",makeStacksButton=(t,e,o={})=>{var{classes:o=[],title:s,danger:a=!1,loading:n=!1,muted:l=!1,primary:i=!1,type:r="filled"}=o;const d=document.createElement("button");return d.id=t,d.textContent=e,d.classList.add("s-btn","s-btn__"+r,...o),d.setAttribute("role","button"),d.setAttribute("aria-label",s||e),a&&d.classList.add("s-btn__danger"),l&&d.classList.add("s-btn__muted"),i&&d.classList.add("s-btn__primary"),n&&d.classList.add("is-loading"),s&&(d.title=s),d},makeStacksIcon=(t,e,o={})=>{const{classes:s=[],hidden:a=!1,namespace:n="http://www.w3.org/2000/svg",height:l=18,width:i=18}=o,r=document.createElementNS(n,"svg"),d=(r.classList.add("svg-icon",t,...s),r.setAttribute("width",i.toString()),r.setAttribute("height",l.toString()),r.setAttribute("viewBox",`0 0 ${i} `+l),r.setAttribute("aria-hidden","true"),a&&r.classList.add("d-none"),document.createElementNS(n,"path"));return d.setAttribute("d",e),r.append(d),r},makeDraggable=e=>{document.addEventListener("dragstart",({dataTransfer:t})=>{const e=document.createElement("img");e.src="data:image/png;base64,AAAAAA==",null!=t&&t.setDragImage(e,0,0)});let d=0,c=0,o=0,s=!1;const a=({clientX:o,clientY:s})=>{var a,n=document.getElementById(e);if(n){d=d||o,c=c||s;let{top:t,left:e}=n["style"];t||e||(a=window.getComputedStyle(n),t=a.top,e=a.left);const l=o-d,i=s-c;if(![l,i].map(Math.abs).some(t=>500<t)){const r=n["style"];r.left=parseInt(e)+l+"px",r.top=parseInt(t)+i+"px",d=o,c=s}}};document.addEventListener("dragstart",t=>{t=t.target;t===document.getElementById(e)&&(s=!0)}),document.addEventListener("dragend",({target:t})=>{t===document.getElementById(e)&&(s=!1,d=0,c=0)}),document.addEventListener("drag",t=>{if(!(3<=(o=t.clientX?0:o<3?o+1:3))&&s)return a(t)}),document.addEventListener("dragover",t=>{if(s&&t.preventDefault(),!(o<3)&&s)return a(t)})},makeStacksModal=(t,e,o)=>{var o=o["minWidth"],s="modal-title";const a=document.createElement("aside"),n=(a.classList.add("s-modal"),a.id=t,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",s),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a)["dataset"],l=(n.sModalTarget="modal",n.controller="s-modal",document.createElement("div")),i=(l.classList.add("s-modal--dialog","ps-relative","hmx6","wmn"+o),l.setAttribute("role","document"),l.id=t+"-document",l.draggable=!0,document.createElement("h1")),r=(i.classList.add("s-modal--header"),i.id=s,i.textContent=e,document.createElement("button"));r.classList.add("s-modal--close","s-btn","s-btn__muted"),r.type="button",r.dataset.action="s-modal#hide";o=makeStacksIcon("iconClearSm","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z",{width:14,height:14});return makeDraggable(l.id),r.append(o),l.append(i,r),a.append(l),[a,l]},observe=(s,a,n)=>{var t=(t,e)=>{var o=a.querySelectorAll(s);o.length&&n([...o],e)};const e=new MutationObserver(t);e.observe(a,{attributes:!0,childList:!0,subtree:!0}),t(0,e)},delay=(e=100)=>new Promise(t=>setTimeout(t,e)),normalizeDatasetPropName=t=>t.split("-").map(([t,...e],o)=>""+(o?t.toUpperCase():t.toLowerCase())+e.join("").toLowerCase()).join(""),followPost=async(t,e,o)=>{const s=new URL(location.origin+`/posts/${e}/vote/21`),a=new URLSearchParams;return a.set("fkey",t),(await fetch(s.toString(),{body:a,credentials:"include",method:"POST",signal:o})).ok},unfollowPost=async(t,e,o)=>{const s=new URL(location.origin+`/posts/${e}/vote/21`),a=(s.searchParams.append("undo","true"),new URLSearchParams);return a.set("fkey",t),(await fetch(s.toString(),{body:a,credentials:"include",method:"POST",signal:o})).ok};let followCount=0;const registerFollowPostObserver=t=>{observe(t,document,async(t,e)=>{if(100<followCount)return console.debug(`[${scriptName}] attempted to follow >= 100 posts, disconnecting`),void e.disconnect();var o,s,a=normalizeDatasetPropName(scriptName+"-state"),n=StackExchange.options.user["fkey"];for(const l of t)"follow"!==l.dataset[a]&&((o=null==(o=null==(o=l.textContent)?void 0:o.toLowerCase())?void 0:o.trim())?+(s=l.id.replace("btnFollowPost-",""))?("follow"===o&&(followCount+=1,await followPost(n,s),l.dataset[a]=o,l.textContent="Following"),await delay(500)):console.debug(`[${scriptName}] failed to get postId from follow button`):console.debug(`[${scriptName}] empty follow button found`))})},registerEditObserver=t=>{const e=normalizeDatasetPropName(scriptName+"-edit-state");observe(t,document,t=>{const o=StackExchange.options.user["fkey"];for(const s of t)"follow"!==s.dataset[e]&&(s.dataset[e]="follow",s.addEventListener("click",async()=>{var t=s.id.replace("submit-button-","");if(+t){await followPost(o,t);const e=document.getElementById("btnFollowPost-"+t);e&&(e.textContent="Following")}else console.debug(`[${scriptName}] invalid post id: `+t)}))})},registerVoteObserver=t=>{const e=normalizeDatasetPropName(scriptName+"-dv-state");observe(t,document,t=>{const a=StackExchange.options.user["fkey"];for(const n of t)"follow"!==n.dataset[e]&&(n.dataset[e]="follow",n.addEventListener("click",async()=>{await delay(1e3);var t=n.getAttribute("aria-pressed");if("true"===t){const o=n.closest(".question, .answer");if(o){var{answerid:t,questionid:e}=o.dataset,t=t||e;if(t){await followPost(a,t);const s=o.querySelector(".js-follow-post");s&&(s.textContent="Following")}else console.debug(`[${scriptName}] missing post id`)}else console.debug(`[${scriptName}] missing post container`)}}))})},unfollowAllPosts=async(e,t)=>{try{var o=StackExchange.options.user["userId"];if(!o)return void console.debug(`[${scriptName}] missing user id`);const d=new URL(location.origin+"/users/"+o),c=d["searchParams"],u=(c.append("tab","following"),c.append("sort","newest"),c.append("page",e.toString()),await fetch(d.toString(),{signal:t}));if(!u.ok)return void console.debug(`[${scriptName}] failed to fetch page ${e} of followed posts`);const w=$(await u.text());var s=w.find("a.s-post-summary--content-title[href*='/questions']").get();if(!s.length)return void console.debug(`[${scriptName}] last page reached`);var a=s.length,n=(window.dispatchEvent(new CustomEvent("unfollow-progress-page",{detail:{numAnchors:a,page:e}})),StackExchange.options.user)["fkey"];for(const p of s){if(t.aborted)return void console.debug(`[${scriptName}] unfollowing aborted`);var[,l,i]=/\/questions\/(\d+)\/.*?(?:\/(\d+)|$)/.exec(p.href)||[],r=i||l;await unfollowPost(n,r,t),window.dispatchEvent(new CustomEvent("unfollow-progress-post",{detail:{numAnchors:a,page:e,postId:r}})),await delay(500)}return await delay(2001),unfollowAllPosts(e+1,t)}catch(t){console.debug(`[${scriptName}] failed to get page ${e} of followed posts:
`+t)}};unsafeWindow.addEventListener("userscript-configurer-load",()=>{const t=((null==(e=unsafeWindow.UserScripters)?void 0:e.Userscripts)||{})["Configurer"];if(t){const o=t.register(scriptName);var e={def:!1,direction:"left",type:"toggle"};o.option("always-follow-questions",{...e,desc:"Autofollow posts on page load"}),o.option("always-follow-answers",{...e,desc:"Autofollow answers on page load"}),o.option("always-follow-upvotes",{...e,desc:"Autofollow posts on voting up"}),o.option("always-follow-downvotes",{...e,desc:"Autofollow posts on voting down"}),o.option("always-follow-edits",{...e,desc:"Autofollow posts on edit"}),o.option("reload-on-done",{...e,desc:"Reload page after unfollowing all posts"})}else console.debug(`[${scriptName}] missing userscript configurer`)}),window.addEventListener("load",async()=>{var t;const e=null==(t=null==(t=null==(t=unsafeWindow.UserScripters)?void 0:t.Userscripts)?void 0:t.Configurer)?void 0:t.get(scriptName),o=(StackExchange.options.user.isAnonymous||(await(null===e||void 0===e?void 0:e.load("always-follow-questions"))&&registerFollowPostObserver(".js-follow-question"),(await(null===e||void 0===e?void 0:e.load("always-follow-answers"))||!1)&&registerFollowPostObserver(".js-follow-answer"),(await(null===e||void 0===e?void 0:e.load("always-follow-upvotes"))||!1)&&registerVoteObserver(".js-vote-up-btn"),(await(null===e||void 0===e?void 0:e.load("always-follow-downvotes"))||!1)&&registerVoteObserver(".js-vote-down-btn"),(await(null===e||void 0===e?void 0:e.load("always-follow-edits"))||!1)&&registerEditObserver(".inline-editor [id^='submit-button']")),new URLSearchParams(location.search));if("following"===o.get("tab")){const s=document.querySelector("#user-tab-following > div:first-child");if(s){const a=makeStacksButton(scriptName+"-unfollow-all-btn","Unfollow all",{classes:["s-btn__xs","flex--item","ml8"],type:"outlined"}),[n,l]=makeStacksModal(scriptName+"-unfollow-all-modal","Unfollow All Posts",{minWidth:25}),i=document.createElement("p"),r=(i.innerHTML=`
            This will initiate an irreversible action of unfollowing <strong>all</strong> of your followed posts on the site.<br/>
            The process is intentionally throttled to avoid rate-limiting.<br/>
            If you still wish to proceed, click the "Start" button below.
            `.trim(),document.createElement("div")),d=(r.classList.add("d-flex","ai-center","gsx","g12"),makeStacksButton(scriptName+"-unfollow-all-start-btn","Start",{classes:["flex--item"],danger:!0,type:"outlined"})),c=makeStacksButton(scriptName+"-unfollow-all-abort-btn","Abort",{classes:["flex--item"],type:"outlined"}),u=document.createElement("div");u.classList.add("flex--item");let o=0;window.addEventListener("unfollow-progress-page",t=>{var t=t["detail"]["page"];u.textContent="Unfollowing page "+t,o=0}),window.addEventListener("unfollow-progress-post",t=>{o+=1;var{numAnchors:t,page:e}=t["detail"];u.textContent=`Unfollowing page ${e} (${o}/${t})`});const w=new AbortController;d.addEventListener("click",async()=>{d.classList.add("is-loading"),await unfollowAllPosts(1,w.signal),d.classList.remove("is-loading"),u.textContent="Finished unfollowing posts",(null===e||void 0===e?!void 0:!e.load("reload-on-done"))&&1||(await delay(1e3),location.reload())}),c.addEventListener("click",()=>w.abort()),a.addEventListener("click",()=>Stacks.showModal(n)),r.append(d,c,u),l.append(i,r),s.append(a),document.body.append(n)}}},{once:!0});